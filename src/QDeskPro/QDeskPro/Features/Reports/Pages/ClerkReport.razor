@page "/clerk/reports"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using QDeskPro.Features.Reports.Services
@using QDeskPro.Features.Admin.Services
@using QDeskPro.Features.Timeline.Components
@using QDeskPro.Domain.Entities
@using QDeskPro.Data
@attribute [Authorize(Roles = "Clerk")]
@rendermode InteractiveServer
@inject ReportService ReportService
@inject ReportExportService ExportService
@inject UserService UserService
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject AppDbContext DbContext
@inject IDialogService DialogService

<PageTitle>Sales Report - QDeskPro</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="report-container py-4">
    @* Modern Page Header *@
    <div class="report-page-header">
        <div class="header-content">
            <div class="header-icon-wrapper">
                <MudIcon Icon="@Icons.Material.Rounded.Assessment" Size="Size.Large" />
            </div>
            <div class="header-text">
                <h1>Sales Report</h1>
                <p>Generate your daily sales reports</p>
            </div>
        </div>
        @if (_reportGenerated)
        {
            <div class="header-stats">
                <div class="stat-badge">
                    <MudIcon Icon="@Icons.Material.Rounded.CalendarToday" Size="Size.Small" />
                    <span>@_selectedDate?.ToString("dd/MM/yy")</span>
                </div>
            </div>
        }
    </div>

    @* Date Selection Card *@
    <div class="date-selection-card">
        <div class="card-header">
            <MudIcon Icon="@Icons.Material.Rounded.DateRange" Size="Size.Small" />
            <span>Select Report Date</span>
        </div>
        <MudGrid>
            <MudItem xs="12" sm="8">
                <MudDatePicker @bind-Date="_selectedDate"
                               Label="Report Date"
                               Variant="Variant.Outlined"
                               DateFormat="dd/MM/yyyy"
                               MinDate="DateTime.Today.AddDays(-5)"
                               MaxDate="DateTime.Today"
                               HelperText="Select a date (up to 5 days back)" />
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           OnClick="GenerateReport"
                           Disabled="_generating"
                           Class="generate-btn"
                           Style="height: 56px;">
                    @if (_generating)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Get Report
                </MudButton>
            </MudItem>
        </MudGrid>
    </div>

    @if (_reportGenerated && _report != null)
    {
        @* Report Header *@
        <MudPaper Class="pa-4 mb-4 report-header" Elevation="0">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <div>
                    <MudText Typo="Typo.h5" Class="font-weight-bold">@_report.ReportTitle</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Generated on @DateTime.Now.ToString("dd/MM/yyyy hh:mm tt")</MudText>
                </div>
                <MudStack Row="true" Spacing="2">
                    <MudMenu AnchorOrigin="Origin.BottomRight"
                             TransformOrigin="Origin.TopRight"
                             ActivationEvent="@MouseEvent.LeftClick">
                        <ActivatorContent>
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Surface"
                                       StartIcon="@Icons.Material.Rounded.Share"
                                       EndIcon="@Icons.Material.Rounded.ArrowDropDown"
                                       Style="background-color: white; color: #1976D2; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                                Export
                            </MudButton>
                        </ActivatorContent>
                        <ChildContent>
                            <MudMenuItem Icon="@Icons.Material.Rounded.TextFields" OnClick="ShareReportText">
                                Share as Text (WhatsApp)
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Rounded.Description" OnClick="ShowRawText">
                                Show Raw Text
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Rounded.PictureAsPdf" OnClick="DownloadPdf">
                                Download PDF
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Rounded.TableChart" OnClick="DownloadExcel">
                                Download Excel
                            </MudMenuItem>
                        </ChildContent>
                    </MudMenu>
                </MudStack>
            </MudStack>
        </MudPaper>

        @* Report Summary *@
        <MudPaper Class="pa-4 mb-4 summary-card" Elevation="0">
            <MudText Typo="Typo.h6" Class="font-weight-bold mb-3">Report Summary</MudText>
            <MudGrid>
                @if (_report.IsSingleDay)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <div class="summary-item">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Opening Balance (B/F)</MudText>
                            <MudText Typo="Typo.h6" Class="font-weight-medium">KES @_report.OpeningBalance.ToString("N0")</MudText>
                        </div>
                    </MudItem>
                }
                <MudItem xs="12" sm="6" md="4">
                    <div class="summary-item">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Quantity</MudText>
                        <MudText Typo="Typo.h6" Class="font-weight-medium">@_report.TotalQuantity.ToString("N0") pcs</MudText>
                    </div>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <div class="summary-item">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Sales</MudText>
                        <MudText Typo="Typo.h6" Class="font-weight-medium" Color="Color.Success">KES @_report.TotalSales.ToString("N0")</MudText>
                    </div>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <div class="summary-item">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Commissions</MudText>
                        <MudText Typo="Typo.h6" Class="font-weight-medium">KES @_report.Commission.ToString("N0")</MudText>
                    </div>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <div class="summary-item">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Loaders Fee</MudText>
                        <MudText Typo="Typo.h6" Class="font-weight-medium">KES @_report.LoadersFee.ToString("N0")</MudText>
                    </div>
                </MudItem>
                @if (_report.LandRateVisible)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <div class="summary-item">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Land Rate</MudText>
                            <MudText Typo="Typo.h6" Class="font-weight-medium">KES @_report.LandRateFee.ToString("N0")</MudText>
                        </div>
                    </MudItem>
                }
                <MudItem xs="12" sm="6" md="4">
                    <div class="summary-item">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Total Expenses</MudText>
                        <MudText Typo="Typo.h6" Class="font-weight-medium" Color="Color.Error">KES @_report.TotalExpenses.ToString("N0")</MudText>
                    </div>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <div class="summary-item">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Earnings</MudText>
                        <MudText Typo="Typo.h6" Class="font-weight-medium">KES @_report.Earnings.ToString("N0")</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="opacity: 0.7; font-size: 0.7rem;">
                            Sales - Total Expenses
                        </MudText>
                    </div>
                </MudItem>
                @if (_report.TotalCollections > 0)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <div class="summary-item collections-highlight">
                            <MudText Typo="Typo.body2" Style="color: #9C27B0;">Collections (Previous Unpaid)</MudText>
                            <MudText Typo="Typo.h6" Class="font-weight-bold" Style="color: #9C27B0;">KES @_report.TotalCollections.ToString("N0")</MudText>
                            <MudText Typo="Typo.caption" Style="opacity: 0.7; font-size: 0.65rem; color: #9C27B0;">
                                @_report.CollectionItems.Count payment(s) received
                            </MudText>
                        </div>
                    </MudItem>
                }
                @if (_report.TotalPrepayments > 0)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <div class="summary-item prepayments-highlight">
                            <MudText Typo="Typo.body2" Style="color: #4CAF50;">Prepayments (Deposits)</MudText>
                            <MudText Typo="Typo.h6" Class="font-weight-bold" Style="color: #4CAF50;">KES @_report.TotalPrepayments.ToString("N0")</MudText>
                            <MudText Typo="Typo.caption" Style="opacity: 0.7; font-size: 0.65rem; color: #4CAF50;">
                                @_report.PrepaymentItems.Count deposit(s) received
                            </MudText>
                        </div>
                    </MudItem>
                }
                @if (_report.UnpaidOrders)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <div class="summary-item unpaid-highlight">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                <div>
                                    <MudText Typo="Typo.body2" Color="Color.Error">Unpaid Orders</MudText>
                                    <MudText Typo="Typo.h6" Class="font-weight-bold" Color="Color.Error">KES @_report.Unpaid.ToString("N0")</MudText>
                                </div>
                                <QuickNoteButton QuarryId="@_quarryId"
                                                 EntityType="UnpaidOrders"
                                                 EntityReference="@($"{_report.Sales.Count(s => s.PaymentStatus != "Paid")} orders totaling KES {_report.Unpaid:N0}")"
                                                 SuggestedTitle="Follow up on unpaid orders"
                                                 DefaultType="Reminder"
                                                 TooltipText="Set reminder for unpaid orders"
                                                 ButtonColor="Color.Error" />
                            </MudStack>
                        </div>
                    </MudItem>
                }
                <MudItem xs="12" sm="6" md="4">
                    <div class="summary-item">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Net Income</MudText>
                        <MudText Typo="Typo.h6" Class="font-weight-medium">KES @_report.NetEarnings.ToString("N0")</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="opacity: 0.7; font-size: 0.7rem;">
                            (Earnings + Opening Balance + Collections + Prepayments) - Unpaid
                        </MudText>
                    </div>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <div class="summary-item banked-highlight">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <MudIcon Icon="@Icons.Material.Rounded.AccountBalance" Size="Size.Medium" Style="color: #1976D2;" />
                            <MudText Typo="Typo.body1" Class="font-weight-bold" Style="color: #1976D2;">BANKED</MudText>
                        </div>
                        <MudText Typo="Typo.h4" Class="font-weight-bold" Style="color: #1976D2; letter-spacing: -0.5px;">
                            KES @_report.Banked.ToString("N0")
                        </MudText>
                        <MudText Typo="Typo.caption" Style="color: #4CAF50; font-weight: 600; margin-top: 4px;">
                            <MudIcon Icon="@Icons.Material.Rounded.TrendingUp" Size="Size.Small" Style="vertical-align: middle;" />
                            Banking Performance
                        </MudText>
                    </div>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <div class="summary-item closing-balance">
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="font-weight-medium">Closing Balance (C/H)</MudText>
                        <MudText Typo="Typo.h6" Class="font-weight-medium">
                            KES @_report.CashInHand.ToString("N0")
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="opacity: 0.6; font-size: 0.65rem;">
                            Net Income - Banked
                        </MudText>
                    </div>
                </MudItem>
            </MudGrid>
        </MudPaper>

        @* Report Sections *@
        <MudExpansionPanels MultiExpansion="true">
            @* Sales Section *@
            <MudExpansionPanel Text="@($"Sales ({_report.Sales.Count} orders)")" Icon="@Icons.Material.Rounded.ShoppingCart" IsInitiallyExpanded="true">
                @if (!_report.Sales.Any())
                {
                    <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Rounded.Info">No sales recorded</MudAlert>
                }
                else
                {
                    <MudTable Items="@_report.Sales" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh>Date</MudTh>
                            <MudTh>Vehicle</MudTh>
                            <MudTh>Product</MudTh>
                            <MudTh Style="text-align: right">Qty</MudTh>
                            <MudTh Style="text-align: right">Amount</MudTh>
                            <MudTh>Status</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Date">@context.SaleDate?.ToString("dd/MM/yy")</MudTd>
                            <MudTd DataLabel="Vehicle">@context.VehicleRegistration</MudTd>
                            <MudTd DataLabel="Product">@context.Product?.ProductName</MudTd>
                            <MudTd DataLabel="Qty" Style="text-align: right">@context.Quantity.ToString("N0")</MudTd>
                            <MudTd DataLabel="Amount" Style="text-align: right" Class="@(context.PaymentStatus != "Paid" ? "unpaid-amount" : "")">
                                <MudText Typo="Typo.body2" Color="@(context.PaymentStatus != "Paid" ? Color.Error : Color.Primary)" Class="font-weight-medium">
                                    KES @context.GrossSaleAmount.ToString("N1")
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Status">
                                @if (context.PaymentStatus == "Paid")
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Paid</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Error">Not Paid</MudChip>
                                }
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudExpansionPanel>

            @* Expenses Section *@
            <MudExpansionPanel Text="@($"Expenses ({_report.ExpenseItems.Count} items)")" Icon="@Icons.Material.Rounded.Receipt" IsInitiallyExpanded="true">
                @if (!_report.ExpenseItems.Any())
                {
                    <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Rounded.Info">No expenses recorded</MudAlert>
                }
                else
                {
                    <MudTable Items="@_report.ExpenseItems" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh>Date</MudTh>
                            <MudTh>Description</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh Style="text-align: right">Amount</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Date">@context.ItemDate.ToString("dd/MM/yy")</MudTd>
                            <MudTd DataLabel="Description">
                                <MudText Typo="Typo.body2">@context.LineItem</MudText>
                            </MudTd>
                            <MudTd DataLabel="Type">
                                <MudChip T="string" Size="Size.Small" Color="@GetExpenseTypeColor(context.LineType)">
                                    @GetExpenseTypeLabel(context.LineType)
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Amount" Style="text-align: right">
                                <MudText Typo="Typo.body2" Class="font-weight-medium">KES @context.Amount.ToString("N1")</MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudExpansionPanel>

            @* Fuel Usage Section *@
            <MudExpansionPanel Text="@($"Fuel Usage ({_report.FuelUsages.Count} records)")" Icon="@Icons.Material.Rounded.LocalGasStation">
                @if (!_report.FuelUsages.Any())
                {
                    <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Rounded.Info">No fuel usage recorded</MudAlert>
                }
                else
                {
                    <MudTable Items="@_report.FuelUsages" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh>Date</MudTh>
                            <MudTh Style="text-align: right">Old Stock</MudTh>
                            <MudTh Style="text-align: right">New Stock</MudTh>
                            <MudTh Style="text-align: right">Total</MudTh>
                            <MudTh Style="text-align: right">Machines</MudTh>
                            <MudTh Style="text-align: right">W/Loaders</MudTh>
                            <MudTh Style="text-align: right">Balance</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Date">@context.UsageDate?.ToString("dd/MM/yy")</MudTd>
                            <MudTd DataLabel="Old Stock" Style="text-align: right">@context.OldStock.ToString("N1")</MudTd>
                            <MudTd DataLabel="New Stock" Style="text-align: right">@context.NewStock.ToString("N1")</MudTd>
                            <MudTd DataLabel="Total" Style="text-align: right" Class="font-weight-medium">@context.TotalStock.ToString("N1")</MudTd>
                            <MudTd DataLabel="Machines" Style="text-align: right">@context.MachinesLoaded.ToString("N1")</MudTd>
                            <MudTd DataLabel="W/Loaders" Style="text-align: right">@context.WheelLoadersLoaded.ToString("N1")</MudTd>
                            <MudTd DataLabel="Balance" Style="text-align: right">
                                <MudText Typo="Typo.body2" Color="Color.Success" Class="font-weight-bold">@context.Balance.ToString("N1")</MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudExpansionPanel>

            @* Banking Section *@
            <MudExpansionPanel Text="@($"Banking ({_report.Bankings.Count} records)")" Icon="@Icons.Material.Rounded.AccountBalance">
                @if (!_report.Bankings.Any())
                {
                    <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Rounded.Info">No banking records</MudAlert>
                }
                else
                {
                    <MudTable Items="@_report.Bankings" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh>Date</MudTh>
                            <MudTh>Description</MudTh>
                            <MudTh>Reference</MudTh>
                            <MudTh Style="text-align: right">Amount</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Date">@context.BankingDate?.ToString("dd/MM/yy")</MudTd>
                            <MudTd DataLabel="Description">@context.Item</MudTd>
                            <MudTd DataLabel="Reference">
                                <MudText Typo="Typo.caption">@context.RefCode</MudText>
                            </MudTd>
                            <MudTd DataLabel="Amount" Style="text-align: right">
                                <MudText Typo="Typo.body2" Class="font-weight-medium">KES @context.AmountBanked.ToString("N1")</MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudExpansionPanel>

            @* Collections Section (Payments received for older unpaid sales) *@
            @if (_report.CollectionItems.Any())
            {
                <MudExpansionPanel Text="@($"Collections ({_report.CollectionItems.Count} payments)")"
                                   Icon="@Icons.Material.Rounded.Payments"
                                   Style="border-left: 4px solid #9C27B0;">
                    <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Rounded.Info" Class="mb-3" Dense="true">
                        These are payments received for sales that were made <strong>before</strong> this report period.
                    </MudAlert>
                    <MudTable Items="@_report.CollectionItems" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh>Sale Date</MudTh>
                            <MudTh>Paid On</MudTh>
                            <MudTh>Vehicle</MudTh>
                            <MudTh>Product</MudTh>
                            <MudTh Style="text-align: right">Qty</MudTh>
                            <MudTh Style="text-align: right">Amount</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Sale Date">@context.OriginalSaleDate.ToString("dd/MM/yy")</MudTd>
                            <MudTd DataLabel="Paid On">@context.PaymentReceivedDate.ToString("dd/MM/yy")</MudTd>
                            <MudTd DataLabel="Vehicle">@context.VehicleRegistration</MudTd>
                            <MudTd DataLabel="Product">@context.ProductName</MudTd>
                            <MudTd DataLabel="Qty" Style="text-align: right">@context.Quantity.ToString("N0")</MudTd>
                            <MudTd DataLabel="Amount" Style="text-align: right">
                                <MudText Typo="Typo.body2" Class="font-weight-medium" Style="color: #9C27B0;">
                                    KES @context.Amount.ToString("N1")
                                </MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                    <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-3">
                        <MudText Typo="Typo.body1" Class="font-weight-bold" Style="color: #9C27B0;">
                            Total Collections: KES @_report.TotalCollections.ToString("N0")
                        </MudText>
                    </MudStack>
                </MudExpansionPanel>
            }

            @* Prepayments Section (Customer deposits received) *@
            @if (_report.PrepaymentItems.Any())
            {
                <MudExpansionPanel Text="@($"Prepayments ({_report.PrepaymentItems.Count} deposits)")"
                                   Icon="@Icons.Material.Rounded.Savings"
                                   Style="border-left: 4px solid #4CAF50;">
                    <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Rounded.Info" Class="mb-3" Dense="true">
                        These are customer deposits/prepayments received during this report period.
                    </MudAlert>
                    <MudTable Items="@_report.PrepaymentItems" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh>Date</MudTh>
                            <MudTh>Vehicle</MudTh>
                            <MudTh>Client</MudTh>
                            <MudTh>Product</MudTh>
                            <MudTh>Reference</MudTh>
                            <MudTh Style="text-align: right">Amount</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Date">@context.PrepaymentDate.ToString("dd/MM/yy")</MudTd>
                            <MudTd DataLabel="Vehicle">@context.VehicleRegistration</MudTd>
                            <MudTd DataLabel="Client">@(context.ClientName ?? "-")</MudTd>
                            <MudTd DataLabel="Product">@context.ProductName</MudTd>
                            <MudTd DataLabel="Reference">
                                <MudText Typo="Typo.caption">@(context.PaymentReference ?? "-")</MudText>
                            </MudTd>
                            <MudTd DataLabel="Amount" Style="text-align: right">
                                <MudText Typo="Typo.body2" Class="font-weight-medium" Style="color: #4CAF50;">
                                    KES @context.AmountPaid.ToString("N1")
                                </MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                    <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-3">
                        <MudText Typo="Typo.body1" Class="font-weight-bold" Style="color: #4CAF50;">
                            Total Prepayments: KES @_report.TotalPrepayments.ToString("N0")
                        </MudText>
                    </MudStack>
                </MudExpansionPanel>
            }
        </MudExpansionPanels>
    }
    else if (!_reportGenerated)
    {
        <div class="empty-state">
            <div class="empty-icon">
                <MudIcon Icon="@Icons.Material.Rounded.Assessment" Size="Size.Large" />
            </div>
            <MudText Typo="Typo.h6" Class="mt-3">No Report Generated</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Select a date and click "Get Report" to generate your daily sales report</MudText>
        </div>
    }
</MudContainer>

<style>
    /* Modern Page Header - Indigo/Blue Theme */
    .report-page-header {
        background: linear-gradient(135deg, #3949AB 0%, #283593 100%);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 8px 32px rgba(40, 53, 147, 0.3);
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .header-icon-wrapper {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .header-text h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        letter-spacing: -0.5px;
    }

    .header-text p {
        margin: 4px 0 0 0;
        opacity: 0.9;
        font-size: 0.9rem;
    }

    .header-stats {
        display: flex;
        gap: 12px;
    }

    .stat-badge {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 8px 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
    }

    /* Date Selection Card */
    .date-selection-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid #E0E6ED;
    }

    .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        color: #1a1a2e;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #E0E6ED;
    }

    .card-header .mud-icon-root {
        color: #3949AB;
    }

    .generate-btn {
        background: linear-gradient(135deg, #3949AB 0%, #283593 100%) !important;
    }

    .generate-btn:hover {
        box-shadow: 0 4px 12px rgba(57, 73, 171, 0.4);
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 20px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid #E0E6ED;
        text-align: center;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, rgba(57, 73, 171, 0.1) 0%, rgba(57, 73, 171, 0.05) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .empty-icon .mud-icon-root {
        color: #3949AB;
    }

    /* Report Header Card */
    .report-header {
        border-radius: 16px;
        background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        color: white;
        box-shadow: 0 8px 24px rgba(25, 118, 210, 0.25);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .report-header:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(25, 118, 210, 0.35);
    }

    /* Summary Card */
    .summary-card {
        border-radius: 16px;
        border: 1px solid #E0E6ED;
        background: white;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .summary-item {
        padding: 20px;
        border-radius: 12px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: 1px solid #e2e8f0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .summary-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #3949AB 0%, #5C6BC0 100%);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .summary-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(57, 73, 171, 0.15);
        border-color: #3949AB;
    }

    .summary-item:hover::before {
        transform: scaleX(1);
    }

    .banked-highlight {
        background: linear-gradient(135deg, rgba(25, 118, 210, 0.18) 0%, rgba(21, 101, 192, 0.12) 100%);
        border: 3px solid #1976D2;
        box-shadow: 0 8px 32px rgba(25, 118, 210, 0.35);
        position: relative;
        overflow: visible;
    }

    .banked-highlight::before {
        background: linear-gradient(90deg, #1976D2 0%, #0D47A1 100%);
        height: 5px;
        transform: scaleX(1);
    }

    .banked-highlight::after {
        content: '‚≠ê';
        position: absolute;
        top: 12px;
        right: 12px;
        font-size: 1.5rem;
        animation: pulse 2s ease-in-out infinite;
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 0.6;
            transform: scale(1);
        }
        50% {
            opacity: 1;
            transform: scale(1.1);
        }
    }

    .banked-highlight:hover {
        box-shadow: 0 12px 48px rgba(25, 118, 210, 0.45);
        transform: translateY(-8px) scale(1.02);
        border-color: #0D47A1;
    }

    .closing-balance {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: 1px solid #cbd5e1;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .closing-balance::before {
        background: linear-gradient(90deg, #94a3b8 0%, #64748b 100%);
        height: 2px;
    }

    .closing-balance:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .unpaid-highlight {
        background: linear-gradient(135deg, rgba(244, 67, 54, 0.12) 0%, rgba(244, 67, 54, 0.06) 100%);
        border: 2px solid #F44336;
        box-shadow: 0 4px 16px rgba(244, 67, 54, 0.15);
    }

    .unpaid-highlight::before {
        background: linear-gradient(90deg, #F44336 0%, #D32F2F 100%);
    }

    .unpaid-amount {
        background: linear-gradient(135deg, rgba(244, 67, 54, 0.1) 0%, rgba(244, 67, 54, 0.05) 100%);
        border-left: 4px solid #F44336;
    }

    .collections-highlight {
        background: linear-gradient(135deg, rgba(156, 39, 176, 0.12) 0%, rgba(156, 39, 176, 0.06) 100%);
        border: 2px solid #9C27B0;
        box-shadow: 0 4px 16px rgba(156, 39, 176, 0.15);
    }

    .collections-highlight::before {
        background: linear-gradient(90deg, #9C27B0 0%, #7B1FA2 100%);
    }

    .prepayments-highlight {
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.12) 0%, rgba(76, 175, 80, 0.06) 100%);
        border: 2px solid #4CAF50;
        box-shadow: 0 4px 16px rgba(76, 175, 80, 0.15);
    }

    .prepayments-highlight::before {
        background: linear-gradient(90deg, #4CAF50 0%, #388E3C 100%);
    }

    /* Dark Mode Support */
    :global(.mud-theme-dark) .report-page-header {
        background: linear-gradient(135deg, #283593 0%, #1A237E 100%);
    }

    :global(.mud-theme-dark) .date-selection-card,
    :global(.mud-theme-dark) .empty-state,
    :global(.mud-theme-dark) .summary-card {
        background: #1e1e1e;
        border-color: #333;
    }

    :global(.mud-theme-dark) .card-header {
        color: #f1f5f9;
        border-color: #333;
    }

    :global(.mud-theme-dark) .empty-icon {
        background: linear-gradient(135deg, rgba(57, 73, 171, 0.2) 0%, rgba(57, 73, 171, 0.1) 100%);
    }

    :global(.mud-theme-dark) .report-header {
        background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
    }

    :global(.mud-theme-dark) .summary-item {
        background: linear-gradient(135deg, #252525 0%, #1e1e1e 100%);
        border-color: #333;
    }

    :global(.mud-theme-dark) .summary-item:hover {
        border-color: #3949AB;
    }

    :global(.mud-theme-dark) .closing-balance {
        background: linear-gradient(135deg, #252525 0%, #1e1e1e 100%);
        border-color: #444;
    }

    :global(.mud-theme-dark) .banked-highlight {
        background: linear-gradient(135deg, rgba(25, 118, 210, 0.25) 0%, rgba(21, 101, 192, 0.15) 100%);
    }

    :global(.mud-theme-dark) .unpaid-highlight {
        background: linear-gradient(135deg, rgba(244, 67, 54, 0.2) 0%, rgba(244, 67, 54, 0.1) 100%);
    }

    :global(.mud-theme-dark) .collections-highlight {
        background: linear-gradient(135deg, rgba(156, 39, 176, 0.2) 0%, rgba(156, 39, 176, 0.1) 100%);
    }

    :global(.mud-theme-dark) .prepayments-highlight {
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(76, 175, 80, 0.1) 100%);
    }

    /* Mobile Responsiveness */
    @@media (max-width: 600px) {
        .report-page-header {
            flex-direction: column;
            gap: 16px;
            text-align: center;
            padding: 20px;
        }

        .header-content {
            flex-direction: column;
            gap: 12px;
        }

        .header-text h1 {
            font-size: 1.5rem;
        }

        .header-stats {
            flex-wrap: wrap;
            justify-content: center;
        }

        .date-selection-card,
        .empty-state,
        .summary-card {
            border-radius: 12px;
        }

        .summary-item {
            padding: 16px;
        }

        .banked-highlight::after {
            top: 8px;
            right: 8px;
            font-size: 1rem;
        }
    }
</style>

@code {
    private DateTime? _selectedDate = DateTime.Today;
    private bool _generating = false;
    private bool _reportGenerated = false;
    private string _userId = "";
    private string _quarryId = "";
    private ClerkReportData? _report;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get user info from auth state
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                _userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";

                // Get user's quarry context from database
                var userContext = await UserService.GetUserQuarryContextAsync(_userId);

                if (userContext != null)
                {
                    _quarryId = userContext.QuarryId;
                }
                else
                {
                    Snackbar.Add("No quarry assigned to your account. Please contact your manager.", Severity.Warning);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error initializing: {ex.Message}", Severity.Error);
        }
    }

    private async Task GenerateReport()
    {
        if (!_selectedDate.HasValue)
        {
            Snackbar.Add("Please select a date", Severity.Warning);
            return;
        }

        _generating = true;
        _reportGenerated = false;

        try
        {
            // Use the same date for both from and to (single day report)
            _report = await ReportService.GenerateClerkReportAsync(
                _selectedDate.Value,
                _selectedDate.Value,
                _quarryId,
                _userId
            );

            _reportGenerated = true;
            Snackbar.Add("Report generated successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error generating report: {ex.Message}", Severity.Error);
        }
        finally
        {
            _generating = false;
        }
    }

    private Color GetExpenseTypeColor(string lineType)
    {
        return lineType switch
        {
            "Commission Expense" => Color.Warning,
            "Loaders Fee Expense" => Color.Info,
            "Land Rate Fee Expense" => Color.Tertiary,
            "User Expense" => Color.Default,
            _ => Color.Default
        };
    }

    private string GetExpenseTypeLabel(string lineType)
    {
        return lineType switch
        {
            "Commission Expense" => "Commission",
            "Loaders Fee Expense" => "Loaders Fee",
            "Land Rate Fee Expense" => "Land Rate",
            "User Expense" => "Manual",
            _ => "Other"
        };
    }

    private async Task ShareReportText()
    {
        if (_report == null)
            return;

        try
        {
            // Get daily notes
            var dailyNotes = await GetDailyNotesAsync();

            // Build PDF download URL with quarryId and userId parameters
            var pdfUrl = NavigationManager.ToAbsoluteUri(
                $"/api/reports/clerk/pdf?fromDate={_report.FromDate:yyyy-MM-dd}&toDate={_report.ToDate:yyyy-MM-dd}&quarryId={_quarryId}&userId={_userId}").ToString();

            // Build markdown report text
            var reportText = ExportService.GenerateMarkdownReport(_report, dailyNotes, pdfUrl);

            // Use Web Share API if available
            await JSRuntime.InvokeVoidAsync("navigator.share", new
            {
                title = $"Sales Report - {_report.ReportTitle}",
                text = reportText
            });
        }
        catch (Exception)
        {
            // Fallback: Copy to clipboard
            try
            {
                var dailyNotes = await GetDailyNotesAsync();
                var pdfUrl = NavigationManager.ToAbsoluteUri(
                    $"/api/reports/clerk/pdf?fromDate={_report.FromDate:yyyy-MM-dd}&toDate={_report.ToDate:yyyy-MM-dd}&quarryId={_quarryId}&userId={_userId}").ToString();
                var reportText = ExportService.GenerateMarkdownReport(_report, dailyNotes, pdfUrl);

                // Use shareText function with HTTP-compatible fallback
                var success = await JSRuntime.InvokeAsync<bool>("shareText", "QDeskPro Report", reportText);
                if (success)
                {
                    Snackbar.Add("Report copied to clipboard", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Failed to copy report to clipboard", Severity.Warning);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error sharing report: {ex.Message}", Severity.Error);
            }
        }
    }

    private void DownloadPdf()
    {
        if (_report == null)
            return;

        try
        {
            var url = $"/api/reports/clerk/pdf?fromDate={_report.FromDate:yyyy-MM-dd}&toDate={_report.ToDate:yyyy-MM-dd}&quarryId={_quarryId}&userId={_userId}";
            NavigationManager.NavigateTo(url, forceLoad: true);
            Snackbar.Add("Generating PDF...", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error downloading PDF: {ex.Message}", Severity.Error);
        }
    }

    private void DownloadExcel()
    {
        if (_report == null)
            return;

        try
        {
            var url = $"/api/reports/clerk/excel?fromDate={_report.FromDate:yyyy-MM-dd}&toDate={_report.ToDate:yyyy-MM-dd}&quarryId={_quarryId}&userId={_userId}";
            NavigationManager.NavigateTo(url, forceLoad: true);
            Snackbar.Add("Generating Excel...", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error downloading Excel: {ex.Message}", Severity.Error);
        }
    }

    private async Task ShowRawText()
    {
        if (_report == null)
            return;

        try
        {
            var dailyNotes = await GetDailyNotesAsync();
            var pdfUrl = NavigationManager.ToAbsoluteUri(
                $"/api/reports/clerk/pdf?fromDate={_report.FromDate:yyyy-MM-dd}&toDate={_report.ToDate:yyyy-MM-dd}&quarryId={_quarryId}&userId={_userId}").ToString();
            var reportText = ExportService.GenerateMarkdownReport(_report, dailyNotes, pdfUrl);

            var parameters = new DialogParameters
            {
                ["ReportText"] = reportText,
                ["Title"] = $"Sales Report - {_report.ReportTitle}"
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Large,
                FullWidth = true,
                CloseButton = true
            };

            await DialogService.ShowAsync<QDeskPro.Features.Reports.Components.RawTextDialog>("Report Text", parameters, options);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error displaying report text: {ex.Message}", Severity.Error);
        }
    }

    private async Task<string?> GetDailyNotesAsync()
    {
        if (_report == null || !_report.IsSingleDay)
            return null;

        try
        {
            var dateStamp = _report.FromDate.ToString("yyyyMMdd");
            var note = await DbContext.DailyNotes
                .Where(n => n.DateStamp == dateStamp)
                .Where(n => n.QId == _quarryId)
                .Where(n => n.IsActive)
                .FirstOrDefaultAsync();

            return note?.Notes;
        }
        catch
        {
            return null;
        }
    }
}
