@page "/manager/products"
@page "/admin/products"
@using QDeskPro.Data
@using QDeskPro.Domain.Entities
@using QDeskPro.Features.MasterData.Services
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@inject AppDbContext DbContext
@inject MasterDataService MasterDataService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize(Policy = "RequireManagerOrAdmin")]
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Products - QDeskPro</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudStack Spacing="4">
        @* Page Header with Gradient *@
        <div class="admin-header admin-header-products">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                    <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Large" Style="color: #FF5722;" />
                    <div>
                        <MudText Typo="Typo.h4" Class="admin-header-title">Products</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            View all available product types
                        </MudText>
                    </div>
                </MudStack>
                <MudChip T="string" Color="Color.Info" Icon="@Icons.Material.Filled.Info" Variant="Variant.Outlined">
                    View Only
                </MudChip>
            </MudStack>
        </div>

        @* Info Card *@
        <div class="admin-info-card">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Info" />
                <MudText>Products are shared across all quarries. To set prices for products at your quarry, use the <strong>Product Prices</strong> page.</MudText>
            </MudStack>
        </div>

        @* Stats Summary Row *@
        <div class="admin-mini-stats-row" style="grid-template-columns: repeat(2, 1fr);">
            <div class="admin-mini-stat admin-mini-stat-gradient-5">
                <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Large" Class="admin-mini-stat-icon" />
                <div class="admin-mini-stat-content">
                    <span class="admin-mini-stat-value">@_products.Count</span>
                    <span class="admin-mini-stat-label">Total Products</span>
                </div>
            </div>
            <div class="admin-mini-stat admin-mini-stat-gradient-4">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Class="admin-mini-stat-icon" />
                <div class="admin-mini-stat-content">
                    <span class="admin-mini-stat-value">@_products.Count(p => p.IsActive)</span>
                    <span class="admin-mini-stat-label">Active</span>
                </div>
            </div>
        </div>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }

        @* Table Card *@
        <div class="admin-table-card">
            <MudTable Items="_products"
                     Hover="true"
                     Breakpoint="Breakpoint.Sm"
                     Dense="true"
                     Loading="_loading"
                     LoadingProgressColor="Color.Primary">
                <HeaderContent>
                    <MudTh>Product Name</MudTh>
                    <MudTh>Description</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Category" Color="Color.Primary" Size="Size.Small" />
                            <MudText>@context.ProductName</MudText>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Description">
                        @(string.IsNullOrWhiteSpace(context.Description) ? "-" : context.Description)
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudIconButton Icon="@Icons.Material.Filled.Info"
                                      Size="Size.Small"
                                      Color="Color.Info"
                                      Class="admin-action-icon"
                                      OnClick="@(() => ShowDetails(context))" />
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <div class="admin-empty-state">
                        <div class="admin-empty-state-icon">
                            <MudIcon Icon="@Icons.Material.Filled.Category" />
                        </div>
                        <MudText Typo="Typo.h6" Color="Color.Default">No products found</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                            Products will appear here once configured
                        </MudText>
                    </div>
                </NoRecordsContent>
            </MudTable>
        </div>
    </MudStack>
</MudContainer>

@* Details Dialog *@
<MudDialog @bind-Visible="_detailsVisible">
    <TitleContent>
        <MudText Typo="Typo.h6">Product Details</MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedProduct != null)
        {
            <MudStack Spacing="2">
                <MudText><strong>Product Name:</strong> @_selectedProduct.ProductName</MudText>
                <MudText><strong>Description:</strong> @(string.IsNullOrWhiteSpace(_selectedProduct.Description) ? "No description" : _selectedProduct.Description)</MudText>
                <MudDivider />
                <MudText Typo="Typo.caption" Class="text-muted">
                    Created: @_selectedProduct.DateCreated.ToString("dd MMM yyyy HH:mm")
                </MudText>
                @if (_selectedProduct.DateModified.HasValue)
                {
                    <MudText Typo="Typo.caption" Class="text-muted">
                        Last Modified: @_selectedProduct.DateModified.Value.ToString("dd MMM yyyy HH:mm")
                    </MudText>
                }
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _detailsVisible = false)">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<Product> _products = new();
    private Product? _selectedProduct;
    private bool _loading = true;
    private bool _detailsVisible = false;
    private string? _userId;
    private string _userRole = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        _userRole = user.FindFirst(ClaimTypes.Role)?.Value ?? string.Empty;

        await LoadProductsAsync();
    }

    private async Task LoadProductsAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _products = await MasterDataService.GetAllProductsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading products: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void ShowDetails(Product product)
    {
        _selectedProduct = product;
        _detailsVisible = true;
    }
}
