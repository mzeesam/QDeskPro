@page "/clerk/sales"
@using Microsoft.AspNetCore.Authorization
@using QDeskPro.Features.Sales.Services
@using QDeskPro.Features.Sales.Components
@using QDeskPro.Features.Admin.Services
@using QDeskPro.Domain.Entities
@attribute [Authorize(Roles = "Clerk")]
@rendermode InteractiveServer
@inject SaleService SaleService
@inject UserService UserService
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<PageTitle>My Sales - QDeskPro</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="sales-list-container py-4">
    @* Modern Page Header *@
    <div class="sales-list-header">
        <div class="header-content">
            <div class="header-icon-wrapper">
                <MudIcon Icon="@Icons.Material.Rounded.Receipt" Size="Size.Large" />
            </div>
            <div class="header-text">
                <h1>My Sales</h1>
                <p>@_allSales.Count total records</p>
            </div>
        </div>
        <div class="header-stats">
            <div class="stat-badge">
                <MudIcon Icon="@Icons.Material.Rounded.ShoppingCart" Size="Size.Small" />
                <span>@_sales.Count</span>
            </div>
        </div>
    </div>

    @* Search and Filter *@
    <div class="search-card">
        <MudTextField @bind-Value="_searchText"
                      Label="Search by Vehicle Registration"
                      Variant="Variant.Outlined"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Rounded.Search"
                      OnKeyUp="OnSearchKeyUp"
                      Immediate="false"
                      DebounceInterval="500"
                      Class="search-input" />
    </div>

    @if (_loading)
    {
        <div class="loading-container">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            <MudText Typo="Typo.body1" Class="mt-3" Color="Color.Secondary">Loading sales...</MudText>
        </div>
    }
    else if (!_sales.Any())
    {
        <div class="empty-state-card">
            <div class="empty-icon">
                <MudIcon Icon="@Icons.Material.Rounded.Inbox" Size="Size.Large" />
            </div>
            <MudText Typo="Typo.h6" Class="mt-3">No sales records to display</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-1">Start by creating your first sale</MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Href="/clerk/sales/new"
                       StartIcon="@Icons.Material.Rounded.Add"
                       Class="mt-4 create-btn">
                Create New Sale
            </MudButton>
        </div>
    }
    else
    {
        <div class="sales-list">
            @foreach (var sale in _sales)
            {
                var isEditable = IsEditableWithin72Hours(sale.SaleDate);
                var isUnpaid = sale.PaymentStatus == "Not Paid";

                <MudCard Class="mb-3 sale-card" Elevation="1">
                    <MudCardContent>
                        <MudGrid>
                            <MudItem xs="12" sm="8">
                                <div class="d-flex align-center mb-2">
                                    <MudIcon Icon="@Icons.Material.Rounded.DirectionsCar" Size="Size.Small" Class="mr-2" />
                                    <MudText Typo="Typo.h6" Class="@(isUnpaid ? "unpaid-text" : "")">
                                        @sale.VehicleRegistration
                                    </MudText>
                                    @if (isUnpaid)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Class="ml-2">Not Paid</MudChip>
                                    }
                                </div>

                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-1">
                                    Qty: <strong>@sale.Quantity.ToString("N0")</strong> |
                                    Product: <strong>@sale.Product?.ProductName</strong> |
                                    Price: <strong>KES @sale.PricePerUnit.ToString("N0")</strong>
                                </MudText>

                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Status: @sale.PaymentStatus |
                                    Ref: @(sale.PaymentReference ?? "N/A") |
                                    Mode: @sale.PaymentMode
                                </MudText>
                            </MudItem>

                            <MudItem xs="12" sm="4" Class="d-flex flex-column align-end justify-space-between">
                                <MudText Typo="Typo.h5" Class="@(isUnpaid ? "unpaid-amount" : "paid-amount")">
                                    KES @sale.GrossSaleAmount.ToString("N1")
                                </MudText>

                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                                    @sale.SaleDate?.ToString("dd/MM/yy | HH:mm")
                                </MudText>

                                <MudStack Row="true" Spacing="1" Class="mt-2">
                                    <MudButton Size="Size.Small"
                                               Variant="Variant.Text"
                                               Color="Color.Info"
                                               OnClick="@(() => ViewSaleDetails(sale))">
                                        View
                                    </MudButton>
                                    @if (isEditable)
                                    {
                                        <MudButton Size="Size.Small"
                                                   Variant="Variant.Text"
                                                   Color="Color.Primary"
                                                   OnClick="@(() => EditSale(sale))">
                                            Edit
                                        </MudButton>
                                        <MudButton Size="Size.Small"
                                                   Variant="Variant.Text"
                                                   Color="Color.Error"
                                                   OnClick="@(() => DeleteSale(sale))">
                                            Delete
                                        </MudButton>
                                    }
                                    else
                                    {
                                        <MudTooltip Text="Can only edit sales within 72 hours">
                                            <MudButton Size="Size.Small"
                                                       Variant="Variant.Text"
                                                       Color="Color.Default"
                                                       Disabled="true">
                                                Edit
                                            </MudButton>
                                        </MudTooltip>
                                    }
                                </MudStack>
                            </MudItem>
                        </MudGrid>
                    </MudCardContent>
                </MudCard>
            }

            @* Load More Button *@
            @if (_hasMore && !_loading)
            {
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           FullWidth="true"
                           OnClick="LoadMore"
                           Class="mt-4">
                    Load More
                </MudButton>
            }
        </div>
    }

    @* FAB for New Sale *@
    <MudFab Color="Color.Primary"
            StartIcon="@Icons.Material.Rounded.Add"
            Href="/clerk/sales/new"
            Style="position: fixed; bottom: 80px; right: 16px;"
            Label="New Sale" />
</MudContainer>

<style>
    /* Container */
    .sales-list-container {
        max-width: 900px;
    }

    /* Modern Header */
    .sales-list-header {
        background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 8px 32px rgba(13, 71, 161, 0.3);
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .header-icon-wrapper {
        width: 56px;
        height: 56px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
    }

    .header-text h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .header-text p {
        margin: 4px 0 0 0;
        opacity: 0.9;
        font-size: 0.875rem;
    }

    .header-stats {
        display: flex;
        gap: 12px;
    }

    .stat-badge {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 8px 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        backdrop-filter: blur(10px);
    }

    /* Search Card */
    .search-card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
    }

    /* Loading State */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 20px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    /* Empty State */
    .empty-state-card {
        background: white;
        border-radius: 16px;
        padding: 60px 24px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        color: #1976D2;
    }

    .create-btn {
        border-radius: 8px;
        text-transform: none;
        font-weight: 600;
        padding: 12px 24px;
    }

    /* Sales List */
    .sales-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* Sale Card */
    .sale-card {
        border-radius: 12px !important;
        border: 1px solid #e2e8f0;
        border-left: 4px solid #1976D2;
        transition: all 0.2s ease;
        overflow: hidden;
    }

    .sale-card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .sale-card.unpaid {
        border-left-color: #F44336;
        background: linear-gradient(135deg, rgba(244, 67, 54, 0.02) 0%, transparent 100%);
    }

    .unpaid-text {
        color: #F44336;
        font-weight: 600;
    }

    .unpaid-amount {
        color: #F44336;
        font-weight: 700;
    }

    .paid-amount {
        color: #1976D2;
        font-weight: 700;
    }

    /* Load More Button */
    .sales-list :deep(.mud-button-outlined) {
        border-radius: 8px;
        text-transform: none;
        font-weight: 600;
        padding: 12px;
    }

    /* FAB Styling */
    :deep(.mud-fab) {
        box-shadow: 0 8px 24px rgba(25, 118, 210, 0.4);
    }

    /* Dark Mode Support */
    :global(.mud-theme-dark) .sales-list-header {
        background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
    }

    :global(.mud-theme-dark) .search-card {
        background: #1e1e1e;
        border-color: #333;
    }

    :global(.mud-theme-dark) .loading-container {
        background: #1e1e1e;
    }

    :global(.mud-theme-dark) .empty-state-card {
        background: #1e1e1e;
        border-color: #333;
    }

    :global(.mud-theme-dark) .empty-icon {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
    }

    :global(.mud-theme-dark) .sale-card {
        background: #1e1e1e;
        border-color: #333;
    }

    :global(.mud-theme-dark) .paid-amount {
        color: #90CAF9;
    }

    /* Mobile Responsiveness */
    @@media (max-width: 600px) {
        .sales-list-header {
            flex-direction: column;
            text-align: center;
            gap: 16px;
            padding: 20px;
        }

        .header-content {
            flex-direction: column;
        }

        .header-icon-wrapper {
            width: 48px;
            height: 48px;
        }

        .header-text h1 {
            font-size: 1.25rem;
        }

        .search-card {
            padding: 12px;
        }

        .empty-state-card {
            padding: 40px 16px;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
        }
    }
</style>

@code {
    private bool _loading = true;
    private string _userId = "";
    private string _quarryId = "";
    private string _searchText = "";

    private List<Sale> _allSales = new();
    private List<Sale> _sales = new();
    private bool _hasMore = false;
    private int _pageSize = 20;
    private int _currentPage = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get user info from auth state
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                _userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";

                // Get user's quarry context from database
                var userContext = await UserService.GetUserQuarryContextAsync(_userId);

                if (userContext != null)
                {
                    _quarryId = userContext.QuarryId;

                    // Load sales
                    await LoadSales();
                }
                else
                {
                    Snackbar.Add("No quarry assigned to your account. Please contact your manager.", Severity.Warning);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading sales: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadSales()
    {
        _loading = true;
        try
        {
            // Get all sales for this clerk
            _allSales = await SaleService.GetSalesForClerkAsync(_userId, _searchText);

            // Sort by date descending
            _allSales = _allSales.OrderByDescending(s => s.SaleDate).ToList();

            // Reset pagination
            _currentPage = 0;
            _sales = _allSales.Take(_pageSize).ToList();
            _hasMore = _allSales.Count > _pageSize;
        }
        finally
        {
            _loading = false;
        }
    }

    private void LoadMore()
    {
        _currentPage++;
        var skip = _currentPage * _pageSize;
        var moreSales = _allSales.Skip(skip).Take(_pageSize).ToList();
        _sales.AddRange(moreSales);
        _hasMore = _allSales.Count > _sales.Count;
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || string.IsNullOrWhiteSpace(_searchText))
        {
            await LoadSales();
        }
    }

    private bool IsEditableWithin72Hours(DateTime? saleDate)
    {
        if (!saleDate.HasValue)
            return false;

        var hoursSinceSale = (DateTime.Now - saleDate.Value).TotalHours;
        return hoursSinceSale <= 72;
    }

    private async Task ViewSaleDetails(Sale sale)
    {
        var parameters = new DialogParameters
        {
            { "Sale", sale }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        await DialogService.ShowAsync<SaleDetailsDialog>("Sale Details", parameters, options);
    }

    private void EditSale(Sale sale)
    {
        NavigationManager.NavigateTo($"/clerk/sales/edit/{sale.Id}");
    }

    private async Task DeleteSale(Sale sale)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Sale",
            $"Are you sure you want to delete this sale: {sale.VehicleRegistration}?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var deleteResult = await SaleService.DeleteSaleAsync(sale.Id, _userId);
                if (deleteResult.Success)
                {
                    Snackbar.Add("Sale deleted successfully", Severity.Success);
                    await LoadSales();
                }
                else
                {
                    Snackbar.Add(deleteResult.Message, Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting sale: {ex.Message}", Severity.Error);
            }
        }
    }
}
