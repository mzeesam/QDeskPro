@page "/clerk/sales/edit/{Id}"
@using Microsoft.AspNetCore.Authorization
@using QDeskPro.Features.Sales.Services
@using QDeskPro.Features.Admin.Services
@using QDeskPro.Domain.Services
@using QDeskPro.Domain.Entities
@attribute [Authorize(Roles = "Clerk")]
@rendermode InteractiveServer
@inject SaleService SaleService
@inject SaleCalculationService CalculationService
@inject UserService UserService
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<PageTitle>Edit Sale - QDeskPro</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="edit-sale-container py-4">
    @* Loading Overlay for Cascade Recalculation *@
    @if (_processing)
    {
        <MudOverlay Visible="true" DarkBackground="true" ZIndex="9999">
            <div class="processing-content">
                <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
                <MudText Class="mt-3" Style="color: white; font-weight: 500;">Saving and recalculating reports...</MudText>
            </div>
        </MudOverlay>
    }

    @* Modern Page Header *@
    <div class="edit-sale-header">
        <div class="header-content">
            <div class="header-icon-wrapper">
                <MudIcon Icon="@Icons.Material.Rounded.Edit" Size="Size.Large" />
            </div>
            <div class="header-text">
                <h1>Edit Sale</h1>
                <p>@(_quarry?.QuarryName ?? "Loading...")</p>
            </div>
        </div>
        <div class="header-badge">
            <MudIcon Icon="@Icons.Material.Rounded.Receipt" Size="Size.Small" />
            <span>@(_sale?.VehicleRegistration ?? "Loading...")</span>
        </div>
    </div>

    @if (_loading)
    {
        <div class="loading-container">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            <MudText Typo="Typo.body1" Class="mt-3" Color="Color.Secondary">Loading sale details...</MudText>
        </div>
    }
    else if (_sale == null)
    {
        <div class="error-card">
            <MudIcon Icon="@Icons.Material.Rounded.Error" Size="Size.Large" Color="Color.Error" />
            <MudText Typo="Typo.h6" Class="mt-3">Sale Not Found</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">The sale you're looking for doesn't exist or you don't have permission to edit it.</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" Href="/clerk/sales">Back to Sales</MudButton>
        </div>
    }
    else
    {
        <MudForm @ref="_form" @bind-IsValid="_isValid">
            @* Sale Details Form Card *@
            <div class="form-card">
                <MudGrid>
                    @* Product Selection *@
                    <MudItem xs="12" sm="6">
                        <MudSelect T="string"
                                   Value="_sale.ProductId"
                                   ValueChanged="OnProductChanged"
                                   Label="Product"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter"
                                   Required="true"
                                   RequiredError="Please specify product">
                            <MudSelectItem Value="@("")">-- Select Product --</MudSelectItem>
                            @foreach (var product in _products)
                            {
                                <MudSelectItem Value="@product.Id">@product.ProductName</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    @* Layer Selection *@
                    <MudItem xs="12" sm="6">
                        <MudSelect @bind-Value="_sale.LayerId"
                                   Label="Layer"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter"
                                   Required="true"
                                   RequiredError="Please specify layer">
                            <MudSelectItem Value="@("")">-- Select Layer --</MudSelectItem>
                            @foreach (var layer in _layers)
                            {
                                <MudSelectItem Value="@layer.Id">@layer.LayerLevel</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    @* Vehicle Registration *@
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_sale.VehicleRegistration"
                                      Label="Vehicle Registration"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="Please provide the vehicle registration details"
                                      MaxLength="90" />
                    </MudItem>

                    @* Sale Date *@
                    <MudItem xs="12" sm="6">
                        <MudDatePicker Date="_saleDate"
                                       DateChanged="OnSaleDateChanged"
                                       Label="Sale Date"
                                       Variant="Variant.Outlined"
                                       Required="true"
                                       RequiredError="Please select a date"
                                       MaxDate="@DateTime.Today"
                                       MinDate="@DateTime.Today.AddDays(-5)"
                                       DateFormat="dd/MM/yyyy" />
                    </MudItem>

                    @* Sale Time *@
                    <MudItem xs="12" sm="6">
                        <MudTimePicker Time="_saleTime"
                                       TimeChanged="OnSaleTimeChanged"
                                       Label="Sale Time"
                                       Variant="Variant.Outlined"
                                       Required="true"
                                       RequiredError="Please select a time"
                                       TimeFormat="HH:mm" />
                    </MudItem>

                    @* Quantity *@
                    <MudItem xs="12" sm="6">
                        <MudNumericField T="double"
                                         @bind-Value="_sale.Quantity"
                                         @bind-Value:after="CalculateOrderSummary"
                                         Label="Quantity"
                                         Variant="Variant.Outlined"
                                         Min="1"
                                         HideSpinButtons="true"
                                         Required="true"
                                         RequiredError="Cannot proceed if quantity not provided" />
                    </MudItem>

                    @* Price Per Unit *@
                    <MudItem xs="12" sm="6">
                        <MudNumericField T="double"
                                         @bind-Value="_sale.PricePerUnit"
                                         @bind-Value:after="CalculateOrderSummary"
                                         Label="Price Per Unit"
                                         Variant="Variant.Outlined"
                                         Min="0"
                                         Required="true"
                                         RequiredError="Cannot proceed if price not provided"
                                         Adornment="Adornment.Start"
                                         AdornmentText="KES" />
                    </MudItem>

                    @* Broker Selection *@
                    <MudItem xs="12" sm="6">
                        <MudSelect @bind-Value="_sale.BrokerId"
                                   Label="Broker (Optional)"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter"
                                   Clearable="true">
                            <MudSelectItem Value="@((string?)null)">-- No Broker --</MudSelectItem>
                            @foreach (var broker in _brokers)
                            {
                                <MudSelectItem Value="@broker.Id">@broker.BrokerName</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    @* Commission Per Unit *@
                    <MudItem xs="12" sm="6">
                        <MudNumericField T="double"
                                         @bind-Value="_sale.CommissionPerUnit"
                                         @bind-Value:after="CalculateOrderSummary"
                                         Label="Commission Per Unit"
                                         Variant="Variant.Outlined"
                                         Min="0"
                                         Adornment="Adornment.Start"
                                         AdornmentText="KES"
                                         Disabled="@(string.IsNullOrWhiteSpace(_sale.BrokerId))" />
                    </MudItem>

                    @* Payment Mode *@
                    <MudItem xs="12" sm="6">
                        <MudSelect @bind-Value="_sale.PaymentMode"
                                   Label="Payment Mode"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="Payment Mode is required">
                            <MudSelectItem Value="@("Cash")">Cash</MudSelectItem>
                            <MudSelectItem Value="@("MPESA")">MPESA</MudSelectItem>
                            <MudSelectItem Value="@("Bank Transfer")">Bank Transfer</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    @* Payment Status *@
                    <MudItem xs="12" sm="6">
                        <MudSelect T="string"
                                   Value="_sale.PaymentStatus"
                                   ValueChanged="OnPaymentStatusChanged"
                                   Label="Payment Status"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="Payment Status is required">
                            <MudSelectItem Value="@("Paid")">Paid</MudSelectItem>
                            <MudSelectItem Value="@("Not Paid")">Not Paid</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    @* Payment Received Date - Only show when changing from NotPaid to Paid *@
                    @if (_showPaymentReceivedDate && _sale.PaymentStatus == "Paid")
                    {
                        <MudItem xs="12" sm="6">
                            <MudDatePicker @bind-Date="_paymentReceivedDate"
                                           Label="Payment Received Date"
                                           Variant="Variant.Outlined"
                                           Required="true"
                                           MaxDate="@DateTime.Today"
                                           MinDate="@DateTime.Today.AddDays(-5)"
                                           DateFormat="dd/MM/yyyy"
                                           HelperText="Date when payment was collected" />
                        </MudItem>
                    }

                    @* Payment Reference *@
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_sale.PaymentReference"
                                      Label="Payment Reference (Optional)"
                                      Variant="Variant.Outlined"
                                      Lines="2" />
                    </MudItem>

                    @* Notes *@
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_sale.Notes"
                                      Label="Notes (Optional)"
                                      Variant="Variant.Outlined"
                                      Lines="2"
                                      Placeholder="Add any additional notes..."
                                      MaxLength="500" />
                    </MudItem>

                    @* Land Rate Option - Always visible for transparency *@
                    <MudItem xs="12">
                        <MudPaper Class="pa-3" Elevation="0" Style="background-color: rgba(76, 175, 80, 0.05); border-radius: 8px;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.body1" Class="font-weight-medium">Include Land Rate Fee</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @if (_landRateVisible)
                                        {
                                            <span>Toggle off to exclude land rate expense for this sale</span>
                                        }
                                        else
                                        {
                                            <span style="color: orange;">Land rate fee not configured for this quarry</span>
                                        }
                                    </MudText>
                                </div>
                                <MudSwitch T="bool"
                                           Value="_sale.IncludeLandRate"
                                           ValueChanged="OnLandRateToggleChanged"
                                           Color="Color.Success"
                                           UnCheckedColor="Color.Default"
                                           Disabled="@(!_landRateVisible)" />
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </div>

            @* Client Details - Expandable Section *@
            <div class="client-details-section">
                <MudExpansionPanels Elevation="0">
                    <MudExpansionPanel Text="Client Details (Optional)" Icon="@Icons.Material.Rounded.Person" Class="client-panel">
                        <MudGrid Class="pt-2">
                            <MudItem xs="12">
                                <MudTextField @bind-Value="_sale.ClientName"
                                              Label="Client Name"
                                              Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="_sale.ClientPhone"
                                              Label="Phone Number"
                                              Variant="Variant.Outlined"
                                              InputType="InputType.Telephone" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudAutocomplete @bind-Value="_sale.Destination"
                                                 Label="Destination"
                                                 SearchFunc="SearchCounties"
                                                 Variant="Variant.Outlined"
                                                 Clearable="true" />
                            </MudItem>
                        </MudGrid>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </div>

            @* Order Summary *@
            <div class="order-summary-card">
                <div class="summary-header">
                    <div class="summary-icon">
                        <MudIcon Icon="@Icons.Material.Rounded.Receipt" />
                    </div>
                    <span>Order Summary</span>
                </div>
                <div class="summary-content">
                    <div class="summary-row">
                        <span class="summary-label">Total Amount</span>
                        <span class="summary-value">KES @_calculations.GrossAmount.ToString("N0")</span>
                    </div>
                    <div class="summary-row deduction">
                        <span class="summary-label">Commission</span>
                        <span class="summary-value">- KES @_calculations.Commission.ToString("N0")</span>
                    </div>
                    <div class="summary-row deduction">
                        <span class="summary-label">Loaders Fee</span>
                        <span class="summary-value">- KES @_calculations.LoadersFee.ToString("N0")</span>
                    </div>
                    @if (_landRateVisible && _sale.IncludeLandRate && _calculations.LandRateFee > 0)
                    {
                        <div class="summary-row deduction">
                            <span class="summary-label">Land Rate Fee</span>
                            <span class="summary-value">- KES @_calculations.LandRateFee.ToString("N0")</span>
                        </div>
                    }
                    else if (_landRateVisible && !_sale.IncludeLandRate)
                    {
                        <div class="summary-row excluded">
                            <span class="summary-label">Land Rate Fee</span>
                            <span class="summary-value">Excluded</span>
                        </div>
                    }
                    <div class="summary-divider"></div>
                    <div class="summary-row total">
                        <span class="summary-label">Net Amount</span>
                        <span class="summary-value">KES @_calculations.NetAmount.ToString("N0")</span>
                    </div>
                </div>
            </div>

            @* Action Buttons *@
            <div class="action-buttons">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Default"
                           OnClick="Cancel"
                           Disabled="_processing"
                           StartIcon="@Icons.Material.Rounded.ArrowBack"
                           Class="cancel-btn">
                    Cancel
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="@(!_isValid || _processing)"
                           OnClick="SubmitSale"
                           StartIcon="@(_processing ? null : Icons.Material.Rounded.Save)"
                           Class="submit-btn">
                    @if (_processing)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" Color="Color.Surface" />
                    }
                    Update Sale
                </MudButton>
            </div>
        </MudForm>
    }
</MudContainer>

<style>
    /* Container Styling */
    .edit-sale-container {
        max-width: 800px;
    }

    /* Processing Overlay Content */
    .processing-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    /* Modern Page Header */
    .edit-sale-header {
        background: linear-gradient(135deg, #F57C00 0%, #E65100 100%);
        border-radius: 16px;
        padding: 24px;
        color: white;
        margin-bottom: 24px;
        box-shadow: 0 8px 32px rgba(230, 81, 0, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .header-icon-wrapper {
        width: 56px;
        height: 56px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
    }

    .header-icon-wrapper .mud-icon-root {
        color: white;
    }

    .header-text h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        letter-spacing: -0.02em;
    }

    .header-text p {
        font-size: 0.9rem;
        margin: 4px 0 0 0;
        opacity: 0.9;
    }

    .header-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 24px;
        padding: 8px 16px;
        font-size: 0.875rem;
        backdrop-filter: blur(10px);
        font-weight: 600;
    }

    /* Loading Container */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        text-align: center;
    }

    /* Error Card */
    .error-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        text-align: center;
        background: white;
        border-radius: 16px;
        border: 1px solid #E8ECF0;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
    }

    /* Form Card */
    .form-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        border: 1px solid #E8ECF0;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
    }

    /* Client Details Section */
    .client-details-section {
        margin-bottom: 20px;
    }

    .client-details-section .mud-expansion-panels {
        background: white;
        border-radius: 16px;
        border: 1px solid #E8ECF0;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .client-panel {
        background: linear-gradient(135deg, rgba(245, 124, 0, 0.03) 0%, rgba(245, 124, 0, 0.01) 100%);
    }

    /* Order Summary Card - Modern Design */
    .order-summary-card {
        background: white;
        border-radius: 16px;
        border: 2px solid #F57C00;
        overflow: hidden;
        margin-bottom: 24px;
        box-shadow: 0 8px 24px rgba(245, 124, 0, 0.15);
    }

    .summary-header {
        background: linear-gradient(135deg, #F57C00 0%, #E65100 100%);
        color: white;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .summary-icon {
        width: 36px;
        height: 36px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .summary-icon .mud-icon-root {
        color: white;
        font-size: 1.25rem;
    }

    .summary-content {
        padding: 20px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
    }

    .summary-label {
        font-size: 0.95rem;
        color: #1a1a2e;
    }

    .summary-value {
        font-size: 0.95rem;
        font-weight: 600;
        color: #1a1a2e;
    }

    .summary-row.deduction .summary-label,
    .summary-row.deduction .summary-value {
        color: #666;
    }

    .summary-row.excluded .summary-label,
    .summary-row.excluded .summary-value {
        color: #999;
        text-decoration: line-through;
        font-style: italic;
    }

    .summary-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, #E0E0E0 20%, #E0E0E0 80%, transparent);
        margin: 8px 0;
    }

    .summary-row.total {
        padding: 16px;
        margin: 8px -20px -20px -20px;
        background: linear-gradient(135deg, rgba(245, 124, 0, 0.08) 0%, rgba(245, 124, 0, 0.04) 100%);
        border-top: 1px solid rgba(245, 124, 0, 0.2);
    }

    .summary-row.total .summary-label {
        font-size: 1.1rem;
        font-weight: 700;
        color: #E65100;
    }

    .summary-row.total .summary-value {
        font-size: 1.25rem;
        font-weight: 800;
        color: #E65100;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        padding: 20px 0;
    }

    .cancel-btn {
        min-width: 120px;
        height: 48px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: none;
        font-size: 1rem;
    }

    .submit-btn {
        min-width: 160px;
        height: 52px;
        border-radius: 12px;
        font-weight: 700;
        text-transform: none;
        font-size: 1.05rem;
        box-shadow: 0 4px 16px rgba(245, 124, 0, 0.4);
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #F57C00 0%, #E65100 100%) !important;
    }

    .submit-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 24px rgba(245, 124, 0, 0.5);
    }

    .submit-btn:disabled {
        box-shadow: none;
    }

    /* Dark Mode Support */
    :global(.mud-theme-dark) .form-card,
    :global(.mud-theme-dark) .client-details-section .mud-expansion-panels,
    :global(.mud-theme-dark) .error-card {
        background: #1E1E1E;
        border-color: #333;
    }

    :global(.mud-theme-dark) .edit-sale-header {
        background: linear-gradient(135deg, #E65100 0%, #F57C00 100%);
    }

    :global(.mud-theme-dark) .order-summary-card {
        background: #1E1E1E;
        border-color: #FFB74D;
    }

    :global(.mud-theme-dark) .summary-header {
        background: linear-gradient(135deg, #E65100 0%, #F57C00 100%);
    }

    :global(.mud-theme-dark) .summary-label,
    :global(.mud-theme-dark) .summary-value {
        color: #f1f5f9;
    }

    :global(.mud-theme-dark) .summary-row.deduction .summary-label,
    :global(.mud-theme-dark) .summary-row.deduction .summary-value {
        color: #94a3b8;
    }

    /* Mobile Responsiveness */
    @@media (max-width: 599px) {
        .edit-sale-header {
            padding: 20px;
            flex-direction: column;
            align-items: flex-start;
        }

        .header-text h1 {
            font-size: 1.5rem;
        }

        .header-badge {
            width: 100%;
            justify-content: center;
        }

        .form-card {
            padding: 16px;
        }

        .summary-content {
            padding: 16px;
        }

        .summary-row.total {
            margin: 8px -16px -16px -16px;
            padding: 12px 16px;
        }

        .action-buttons {
            flex-direction: column-reverse;
            gap: 12px;
        }

        .cancel-btn,
        .submit-btn {
            width: 100%;
        }
    }
</style>

@code {
    [Parameter]
    public string Id { get; set; } = "";

    private MudForm? _form;
    private bool _isValid = false;
    private bool _loading = true;
    private bool _processing = false;
    private string _userId = "";
    private string _userFullName = "";
    private string _quarryId = "";
    private bool _landRateVisible = true;

    private Sale? _sale;
    private DateTime? _saleDate;
    private TimeSpan? _saleTime;
    private string _originalPaymentStatus = "";  // Track original status for collections logic
    private bool _showPaymentReceivedDate = false;  // Show date picker when status changes to Paid
    private DateTime? _paymentReceivedDate;  // Date when payment was received

    private List<Product> _products = new();
    private List<Layer> _layers = new();
    private List<Broker> _brokers = new();
    private Quarry? _quarry;
    private SaleCalculationResult _calculations = new();

    // Kenya counties for destination dropdown
    private static readonly string[] KenyaCounties = new[]
    {
        "Baringo", "Bomet", "Bungoma", "Busia", "Elgeyo-Marakwet",
        "Embu", "Garissa", "Homa Bay", "Isiolo", "Kajiado",
        "Kakamega", "Kericho", "Kiambu", "Kilifi", "Kirinyaga",
        "Kisii", "Kisumu", "Kitui", "Kwale", "Laikipia",
        "Lamu", "Machakos", "Makueni", "Mandera", "Marsabit",
        "Meru", "Migori", "Mombasa", "Murang'a", "Nairobi",
        "Nakuru", "Nandi", "Narok", "Nyamira", "Nyandarua",
        "Nyeri", "Samburu", "Siaya", "Taita-Taveta", "Tana River",
        "Tharaka-Nithi", "Trans-Nzoia", "Turkana", "Uasin Gishu",
        "Vihiga", "Wajir", "West Pokot"
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get user info from auth state
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                _userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";

                // Get user's quarry context from database
                var userContext = await UserService.GetUserQuarryContextAsync(_userId);

                if (userContext != null)
                {
                    _userFullName = userContext.UserFullName;
                    _quarryId = userContext.QuarryId;
                    _quarry = userContext.Quarry;

                    // Load master data
                    _products = await SaleService.GetProductsAsync();
                    _layers = await SaleService.GetLayersForQuarryAsync(_quarryId);
                    _brokers = await SaleService.GetBrokersForQuarryAsync(_quarryId);

                    // Load the sale
                    _sale = await SaleService.GetSaleByIdAsync(Id);

                    if (_sale != null)
                    {
                        // Verify this sale belongs to this clerk
                        if (_sale.ApplicationUserId != _userId)
                        {
                            Snackbar.Add("You don't have permission to edit this sale.", Severity.Error);
                            _sale = null;
                        }
                        else
                        {
                            // Extract date and time from SaleDate
                            if (_sale.SaleDate.HasValue)
                            {
                                _saleDate = _sale.SaleDate.Value.Date;
                                _saleTime = _sale.SaleDate.Value.TimeOfDay;
                            }
                            else
                            {
                                _saleDate = DateTime.Today;
                                _saleTime = DateTime.Now.TimeOfDay;
                            }

                            // Track original payment status for collections logic
                            _originalPaymentStatus = _sale.PaymentStatus ?? "";
                            _paymentReceivedDate = _sale.PaymentReceivedDate?.Date ?? DateTime.Today;

                            // Calculate initial summary
                            CalculateOrderSummary();
                        }
                    }
                    else
                    {
                        Snackbar.Add("Sale not found.", Severity.Error);
                    }

                    // Check if land rate is visible
                    _landRateVisible = _quarry?.LandRateFee > 0;
                }
                else
                {
                    Snackbar.Add("No quarry assigned to your account. Please contact your manager.", Severity.Warning);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading sale: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnProductChanged(string productId)
    {
        if (_sale == null) return;

        // Update the sale's product ID
        _sale.ProductId = productId;

        if (!string.IsNullOrWhiteSpace(productId) && !string.IsNullOrWhiteSpace(_quarryId))
        {
            try
            {
                // Auto-load price for this product at this quarry
                var productPrice = await SaleService.GetProductPriceAsync(productId, _quarryId);
                if (productPrice != null)
                {
                    _sale.PricePerUnit = productPrice.Price;
                }
                else
                {
                    _sale.PricePerUnit = 0;
                }

                // Trigger order summary recalculation
                CalculateOrderSummary();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading product price: {ex.Message}", Severity.Error);
            }
        }
    }

    private void CalculateOrderSummary()
    {
        if (_sale == null) return;

        // Sync sale date and time
        if (_saleDate.HasValue && _saleTime.HasValue)
        {
            _sale.SaleDate = _saleDate.Value.Date.Add(_saleTime.Value);
        }
        else if (_saleDate.HasValue)
        {
            _sale.SaleDate = _saleDate.Value;
        }

        // Get selected product name for land rate calculation
        var selectedProduct = _products.FirstOrDefault(p => p.Id == _sale.ProductId);
        var productName = selectedProduct?.ProductName ?? "";

        // Calculate all amounts (respecting land rate inclusion flag)
        // Don't apply loaders fee for beam or hardcore products
        var loadersFee = (productName.Contains("beam", StringComparison.OrdinalIgnoreCase) ||
                         productName.Contains("hardcore", StringComparison.OrdinalIgnoreCase))
            ? null
            : _quarry?.LoadersFee;

        _calculations = CalculationService.CalculateAll(
            _sale.Quantity,
            _sale.PricePerUnit,
            _sale.CommissionPerUnit,
            productName,
            loadersFee,
            _quarry?.LandRateFee,
            _quarry?.RejectsFee,
            _sale.IncludeLandRate
        );

        StateHasChanged();
    }

    private void OnLandRateToggleChanged(bool value)
    {
        if (_sale == null) return;
        _sale.IncludeLandRate = value;
        CalculateOrderSummary();
    }

    private void OnSaleDateChanged(DateTime? date)
    {
        _saleDate = date;
        SyncSaleDateTime();
    }

    private void OnSaleTimeChanged(TimeSpan? time)
    {
        _saleTime = time;
        SyncSaleDateTime();
    }

    private void SyncSaleDateTime()
    {
        if (_sale == null) return;

        if (_saleDate.HasValue && _saleTime.HasValue)
        {
            _sale.SaleDate = _saleDate.Value.Date.Add(_saleTime.Value);
        }
        else if (_saleDate.HasValue)
        {
            _sale.SaleDate = _saleDate.Value;
        }
        CalculateOrderSummary();
    }

    private void OnPaymentStatusChanged(string? newStatus)
    {
        if (_sale == null) return;

        _sale.PaymentStatus = newStatus;

        // Show payment received date picker when changing from NotPaid to Paid
        // This is important for collections tracking - we need to know WHEN payment was received
        if (newStatus == "Paid" && _originalPaymentStatus != "Paid")
        {
            _showPaymentReceivedDate = true;
            _paymentReceivedDate = DateTime.Today;  // Default to today
        }
        else if (newStatus != "Paid")
        {
            _showPaymentReceivedDate = false;
            _paymentReceivedDate = null;
        }
        else
        {
            // Already was Paid and still is Paid - don't show the picker
            _showPaymentReceivedDate = false;
        }

        StateHasChanged();
    }

    private async Task SubmitSale()
    {
        if (_sale == null) return;

        // Sync sale date and time
        if (_saleDate.HasValue && _saleTime.HasValue)
        {
            _sale.SaleDate = _saleDate.Value.Date.Add(_saleTime.Value);
        }
        else if (_saleDate.HasValue)
        {
            _sale.SaleDate = _saleDate.Value;
        }

        // Set PaymentReceivedDate for collections tracking
        // This tells the service when payment was actually received
        if (_showPaymentReceivedDate && _paymentReceivedDate.HasValue)
        {
            _sale.PaymentReceivedDate = _paymentReceivedDate.Value;
        }

        // Show confirmation dialog
        var selectedProduct = _products.FirstOrDefault(p => p.Id == _sale.ProductId);
        var confirmMessage = $"Update '{_sale.VehicleRegistration} - {selectedProduct?.ProductName}' {_sale.Quantity:N0} pieces?";

        var result = await DialogService.ShowMessageBox(
            "Confirm Update",
            confirmMessage,
            yesText: "Update", cancelText: "Cancel");

        if (result != true)
            return;

        _processing = true;
        try
        {
            var (success, message) = await SaleService.UpdateSaleAsync(_sale, _userId);

            if (success)
            {
                Snackbar.Add(message, Severity.Success);
                // Navigate back to sales list
                NavigationManager.NavigateTo("/clerk/sales");
            }
            else
            {
                Snackbar.Add(message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating sale: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/clerk/sales");
    }

    private async Task<IEnumerable<string>> SearchCounties(string value, CancellationToken token)
    {
        await Task.Delay(5, token); // Small delay for responsiveness

        if (string.IsNullOrWhiteSpace(value))
            return KenyaCounties;

        return KenyaCounties.Where(c => c.Contains(value, StringComparison.OrdinalIgnoreCase));
    }
}
