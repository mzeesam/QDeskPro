@page "/clerk/sales/new"
@using Microsoft.AspNetCore.Authorization
@using QDeskPro.Features.Sales.Services
@using QDeskPro.Features.Prepayments.Services
@using QDeskPro.Features.Admin.Services
@using QDeskPro.Domain.Services
@using QDeskPro.Domain.Entities
@using Microsoft.AspNetCore.WebUtilities
@attribute [Authorize(Roles = "Clerk")]
@rendermode InteractiveServer
@inject SaleService SaleService
@inject PrepaymentService PrepaymentService
@inject SaleCalculationService CalculationService
@inject UserService UserService
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<PageTitle>New Sale - QDeskPro</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-4">
    <MudText Typo="Typo.h4" Class="font-weight-bold mb-4">
        <MudIcon Icon="@Icons.Material.Rounded.AddShoppingCart" Class="mr-2" />
        New Sale
    </MudText>

    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        @* Prepayment Application Section (Optional) *@
        <MudExpansionPanels Class="mb-4">
            <MudExpansionPanel Text="Apply Prepayment (Optional)"
                               Icon="@Icons.Material.Rounded.AccountBalanceWallet"
                               IsExpanded="@(_selectedPrepayment != null)">
                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_vehicleSearchQuery"
                                      Label="Search Vehicle Registration"
                                      Variant="Variant.Outlined"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@Icons.Material.Rounded.Search"
                                      OnKeyUp="SearchPrepayments"
                                      OnAdornmentClick="SearchPrepayments"
                                      Clearable="true"
                                      Placeholder="Enter at least 2 characters to search"
                                      Immediate="false" />
                    </MudItem>

                    @if (_searchingPrepayments)
                    {
                        <MudItem xs="12">
                            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-2" />
                        </MudItem>
                    }

                    @if (_availablePrepayments.Any())
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">Available Prepayments:</MudText>
                            <MudList T="string" Dense="true">
                                @foreach (var prep in _availablePrepayments)
                                {
                                    var isSelected = _selectedPrepayment?.Id == prep.Id;
                                    <MudListItem T="string" OnClick="@(() => SelectPrepayment(prep))"
                                                 Class="@(isSelected ? "selected-prepayment" : "prepayment-item")"
                                                 Style="cursor: pointer; border-radius: 8px; margin-bottom: 8px;">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <div>
                                                <MudText Typo="Typo.body1" Class="font-weight-bold">@prep.VehicleRegistration</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    @prep.PrepaymentDate.ToString("dd/MM/yyyy")
                                                    @if (!string.IsNullOrWhiteSpace(prep.ClientName))
                                                    {
                                                        <text> • @prep.ClientName</text>
                                                    }
                                                    @if (prep.IntendedProduct != null)
                                                    {
                                                        <text> • @prep.IntendedProduct.ProductName</text>
                                                    }
                                                </MudText>
                                            </div>
                                            <MudStack Spacing="1" AlignItems="AlignItems.End">
                                                <MudText Typo="Typo.body1" Color="Color.Success" Class="font-weight-bold">
                                                    KES @prep.RemainingBalance.ToString("N0")
                                                </MudText>
                                                <MudChip T="string" Size="Size.Small" Color="Color.Warning">@prep.Status</MudChip>
                                            </MudStack>
                                        </MudStack>
                                    </MudListItem>
                                }
                            </MudList>
                        </MudItem>
                    }

                    @if (_selectedPrepayment != null)
                    {
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Success" Icon="@Icons.Material.Rounded.CheckCircle" Class="mt-2">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <div>
                                        <MudText Typo="Typo.body1" Class="font-weight-bold">
                                            Prepayment Selected: KES @_selectedPrepayment.RemainingBalance.ToString("N0") available
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            @_selectedPrepayment.VehicleRegistration
                                            @if (_selectedPrepayment.IntendedProduct != null)
                                            {
                                                <text> • Est. @(_estimatedQuantity.ToString("N0")) pieces of @_selectedPrepayment.IntendedProduct.ProductName</text>
                                            }
                                        </MudText>
                                    </div>
                                    <MudButton Size="Size.Small"
                                               Variant="Variant.Text"
                                               Color="Color.Error"
                                               OnClick="ClearPrepayment"
                                               StartIcon="@Icons.Material.Rounded.Clear">
                                        Clear
                                    </MudButton>
                                </MudStack>
                            </MudAlert>
                        </MudItem>
                    }
                </MudGrid>
            </MudExpansionPanel>
        </MudExpansionPanels>

        <MudForm @ref="_form" @bind-IsValid="_isValid">
            <MudPaper Class="pa-4 mb-4" Elevation="0">
                <MudGrid>
                    @* Product Selection *@
                    <MudItem xs="12" sm="6">
                        <MudSelect T="string"
                                   Value="_sale.ProductId"
                                   ValueChanged="OnProductChanged"
                                   Label="Product"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter"
                                   Required="true"
                                   RequiredError="Please specify product">
                            <MudSelectItem Value="@("")">-- Select Product --</MudSelectItem>
                            @foreach (var product in _products)
                            {
                                <MudSelectItem Value="@product.Id">@product.ProductName</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    @* Layer Selection *@
                    <MudItem xs="12" sm="6">
                        <MudSelect @bind-Value="_sale.LayerId"
                                   Label="Layer"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter"
                                   Required="true"
                                   RequiredError="Please specify layer">
                            <MudSelectItem Value="@("")">-- Select Layer --</MudSelectItem>
                            @foreach (var layer in _layers)
                            {
                                <MudSelectItem Value="@layer.Id">@layer.LayerLevel</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    @* Vehicle Registration *@
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_sale.VehicleRegistration"
                                      Label="Vehicle Registration"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="Please provide the vehicle registration details"
                                      MaxLength="90" />
                    </MudItem>

                    @* Sale Date *@
                    <MudItem xs="12" sm="6">
                        <MudDatePicker Date="_saleDate"
                                       DateChanged="OnSaleDateChanged"
                                       Label="Sale Date"
                                       Variant="Variant.Outlined"
                                       Required="true"
                                       RequiredError="Please select a date"
                                       MaxDate="@DateTime.Today"
                                       MinDate="@DateTime.Today.AddDays(-5)"
                                       DateFormat="dd/MM/yyyy" />
                    </MudItem>

                    @* Sale Time *@
                    <MudItem xs="12" sm="6">
                        <MudTimePicker Time="_saleTime"
                                       TimeChanged="OnSaleTimeChanged"
                                       Label="Sale Time"
                                       Variant="Variant.Outlined"
                                       Required="true"
                                       RequiredError="Please select a time"
                                       TimeFormat="HH:mm" />
                    </MudItem>

                    @* Quantity *@
                    <MudItem xs="12" sm="6">
                        <MudNumericField Value="_sale.Quantity"
                                         Label="Quantity"
                                         Variant="Variant.Outlined"
                                         Min="1"
                                         Required="true"
                                         RequiredError="Cannot proceed if quantity not provided"
                                         ValueChanged="@((double val) => { _sale.Quantity = val; CalculateOrderSummary(); })" />
                    </MudItem>

                    @* Price Per Unit *@
                    <MudItem xs="12" sm="6">
                        <MudNumericField Value="_sale.PricePerUnit"
                                         Label="Price Per Unit"
                                         Variant="Variant.Outlined"
                                         Min="0"
                                         Required="true"
                                         RequiredError="Cannot proceed if price not provided"
                                         ValueChanged="@((double val) => { _sale.PricePerUnit = val; CalculateOrderSummary(); })"
                                         Adornment="Adornment.Start"
                                         AdornmentText="KES" />
                    </MudItem>

                    @* Broker Selection *@
                    <MudItem xs="12" sm="6">
                        <MudSelect @bind-Value="_sale.BrokerId"
                                   Label="Broker (Optional)"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter"
                                   Clearable="true">
                            <MudSelectItem Value="@((string?)null)">-- No Broker --</MudSelectItem>
                            @foreach (var broker in _brokers)
                            {
                                <MudSelectItem Value="@broker.Id">@broker.BrokerName</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    @* Commission Per Unit *@
                    <MudItem xs="12" sm="6">
                        <MudNumericField Value="_sale.CommissionPerUnit"
                                         Label="Commission Per Unit"
                                         Variant="Variant.Outlined"
                                         Min="0"
                                         ValueChanged="@((double val) => { _sale.CommissionPerUnit = val; CalculateOrderSummary(); })"
                                         Adornment="Adornment.Start"
                                         AdornmentText="KES"
                                         Disabled="@(string.IsNullOrWhiteSpace(_sale.BrokerId))" />
                    </MudItem>

                    @* Payment Mode *@
                    <MudItem xs="12" sm="6">
                        <MudSelect @bind-Value="_sale.PaymentMode"
                                   Label="Payment Mode"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="Payment Mode is required">
                            <MudSelectItem Value="@("Cash")">Cash</MudSelectItem>
                            <MudSelectItem Value="@("MPESA")">MPESA</MudSelectItem>
                            <MudSelectItem Value="@("Bank Transfer")">Bank Transfer</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    @* Payment Status *@
                    <MudItem xs="12" sm="6">
                        <MudSelect @bind-Value="_sale.PaymentStatus"
                                   Label="Payment Status"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="Payment Status is required">
                            <MudSelectItem Value="@("Paid")">Paid</MudSelectItem>
                            <MudSelectItem Value="@("Not Paid")">Not Paid</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    @* Payment Reference *@
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_sale.PaymentReference"
                                      Label="Payment Reference (Optional)"
                                      Variant="Variant.Outlined"
                                      Lines="2" />
                    </MudItem>

                    @* Land Rate Option - Always visible for transparency *@
                    <MudItem xs="12">
                        <MudPaper Class="pa-3" Elevation="0" Style="background-color: rgba(76, 175, 80, 0.05); border-radius: 8px;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.body1" Class="font-weight-medium">Include Land Rate Fee</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @if (_landRateVisible)
                                        {
                                            <span>Toggle to include or exclude land rate expense for this sale</span>
                                        }
                                        else
                                        {
                                            <span style="color: orange;">Land rate fee not configured for this quarry</span>
                                        }
                                    </MudText>
                                </div>
                                <MudSwitch T="bool"
                                           Value="_sale.IncludeLandRate"
                                           ValueChanged="OnLandRateToggleChanged"
                                           Color="Color.Success"
                                           UnCheckedColor="Color.Default"
                                           Disabled="@(!_landRateVisible)" />
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            @* Client Details - Expandable Section *@
            <MudExpansionPanels Class="mb-4">
                <MudExpansionPanel Text="Client Details (Optional)" Icon="@Icons.Material.Rounded.Person">
                    <MudGrid Class="pt-2">
                        <MudItem xs="12">
                            <MudTextField @bind-Value="_sale.ClientName"
                                          Label="Client Name"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_sale.ClientPhone"
                                          Label="Phone Number"
                                          Variant="Variant.Outlined"
                                          InputType="InputType.Telephone" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudAutocomplete @bind-Value="_sale.Destination"
                                             Label="Destination"
                                             SearchFunc="SearchCounties"
                                             Variant="Variant.Outlined"
                                             Clearable="true" />
                        </MudItem>
                    </MudGrid>
                </MudExpansionPanel>
            </MudExpansionPanels>

            @* Order Summary *@
            <MudPaper Class="pa-4 mb-4 order-summary-card" Elevation="0">
                <MudText Typo="Typo.h6" Class="font-weight-bold mb-3">Order Summary</MudText>
                <MudStack Spacing="2">
                    <div class="d-flex justify-space-between">
                        <MudText>Total Amount</MudText>
                        <MudText Typo="Typo.body1" Class="font-weight-medium">KES @_calculations.GrossAmount.ToString("N1")</MudText>
                    </div>
                    <div class="d-flex justify-space-between">
                        <MudText Color="Color.Secondary">Commission</MudText>
                        <MudText Color="Color.Secondary">- KES @_calculations.Commission.ToString("N1")</MudText>
                    </div>
                    <div class="d-flex justify-space-between">
                        <MudText Color="Color.Secondary">Loaders Fee</MudText>
                        <MudText Color="Color.Secondary">- KES @_calculations.LoadersFee.ToString("N1")</MudText>
                    </div>
                    @if (_landRateVisible && _sale.IncludeLandRate && _calculations.LandRateFee > 0)
                    {
                        <div class="d-flex justify-space-between">
                            <MudText Color="Color.Secondary">Land Rate Fee</MudText>
                            <MudText Color="Color.Secondary">- KES @_calculations.LandRateFee.ToString("N1")</MudText>
                        </div>
                    }
                    else if (_landRateVisible && !_sale.IncludeLandRate)
                    {
                        <div class="d-flex justify-space-between">
                            <MudText Color="Color.Secondary" Style="text-decoration: line-through;">Land Rate Fee</MudText>
                            <MudText Color="Color.Secondary" Style="text-decoration: line-through;">Excluded</MudText>
                        </div>
                    }
                    @if (_selectedPrepayment != null)
                    {
                        <MudDivider Class="my-2" />
                        <div class="d-flex justify-space-between">
                            <MudText Color="Color.Success">Prepayment Applied</MudText>
                            <MudText Color="Color.Success">- KES @PrepaymentAppliedAmount.ToString("N1")</MudText>
                        </div>
                    }
                    <MudDivider Class="my-2" />
                    <div class="d-flex justify-space-between">
                        <MudText Typo="Typo.h6">@(_selectedPrepayment != null ? "Balance Due" : "Net Amount")</MudText>
                        <MudText Typo="Typo.h6" Color="@(BalanceDue > 0 && _selectedPrepayment != null ? Color.Warning : Color.Primary)" Class="font-weight-bold" Style="text-decoration: underline;">
                            KES @BalanceDue.ToString("N1")
                        </MudText>
                    </div>
                </MudStack>
            </MudPaper>

            @* Action Buttons *@
            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-4">
                <MudButton Variant="Variant.Text"
                           OnClick="Cancel"
                           Disabled="_processing">
                    Cancel
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="@(!_isValid || _processing)"
                           OnClick="SubmitSale"
                           Class="touch-target">
                    @if (_processing)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Submit Sale
                </MudButton>
            </MudStack>
        </MudForm>
    }
</MudContainer>

<style>
    .order-summary-card {
        border-radius: 16px;
        border: 2px solid #1976D2;
        background: linear-gradient(135deg, rgba(25, 118, 210, 0.05) 0%, rgba(25, 118, 210, 0.02) 100%);
    }

    .touch-target {
        min-height: 44px;
        min-width: 44px;
    }

    .prepayment-item {
        padding: 12px;
        border: 1px solid #e0e0e0;
        transition: all 0.2s ease;
    }

    .prepayment-item:hover {
        background-color: rgba(76, 175, 80, 0.08);
        border-color: #4CAF50;
    }

    .selected-prepayment {
        padding: 12px;
        background-color: rgba(76, 175, 80, 0.12);
        border: 2px solid #4CAF50;
    }
</style>

@code {
    private MudForm? _form;
    private bool _isValid = false;
    private bool _loading = true;
    private bool _processing = false;
    private string _userId = "";
    private string _userFullName = "";
    private string _quarryId = "";
    private bool _landRateVisible = true;

    private Sale _sale = new()
    {
        SaleDate = DateTime.Now,
        PaymentMode = "MPESA",
        PaymentStatus = "Paid",
        Quantity = 0,
        PricePerUnit = 0,
        CommissionPerUnit = 1
    };

    private DateTime? _saleDate = DateTime.Today;
    private TimeSpan? _saleTime = DateTime.Now.TimeOfDay;

    private List<Product> _products = new();
    private List<Layer> _layers = new();
    private List<Broker> _brokers = new();
    private Quarry? _quarry;
    private SaleCalculationResult _calculations = new();

    // Prepayment-related fields
    private string _vehicleSearchQuery = "";
    private bool _searchingPrepayments = false;
    private List<Prepayment> _availablePrepayments = new();
    private Prepayment? _selectedPrepayment = null;
    private double _estimatedQuantity = 0;

    // Calculated prepayment amounts
    private double PrepaymentAppliedAmount =>
        _selectedPrepayment != null
        ? Math.Min(_selectedPrepayment.RemainingBalance, _calculations.GrossAmount)
        : 0;

    private double BalanceDue =>
        _selectedPrepayment != null
            ? _calculations.GrossAmount - PrepaymentAppliedAmount  // What customer still owes
            : _calculations.NetAmount;  // What quarry keeps after deductions

    // Kenya counties for destination dropdown
    private static readonly string[] KenyaCounties = new[]
    {
        "Baringo", "Bomet", "Bungoma", "Busia", "Elgeyo-Marakwet",
        "Embu", "Garissa", "Homa Bay", "Isiolo", "Kajiado",
        "Kakamega", "Kericho", "Kiambu", "Kilifi", "Kirinyaga",
        "Kisii", "Kisumu", "Kitui", "Kwale", "Laikipia",
        "Lamu", "Machakos", "Makueni", "Mandera", "Marsabit",
        "Meru", "Migori", "Mombasa", "Murang'a", "Nairobi",
        "Nakuru", "Nandi", "Narok", "Nyamira", "Nyandarua",
        "Nyeri", "Samburu", "Siaya", "Taita-Taveta", "Tana River",
        "Tharaka-Nithi", "Trans-Nzoia", "Turkana", "Uasin Gishu",
        "Vihiga", "Wajir", "West Pokot"
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get user info from auth state
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                _userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";

                // Get user's quarry context from database
                var userContext = await UserService.GetUserQuarryContextAsync(_userId);

                if (userContext != null)
                {
                    _userFullName = userContext.UserFullName;
                    _quarryId = userContext.QuarryId;
                    _quarry = userContext.Quarry;

                    // Load master data
                    _products = await SaleService.GetProductsAsync();
                    _layers = await SaleService.GetLayersForQuarryAsync(_quarryId);
                    _brokers = await SaleService.GetBrokersForQuarryAsync(_quarryId);

                    // Set default broker if available
                    if (_brokers.Any())
                    {
                        _sale.BrokerId = _brokers.First().Id;
                    }

                    // Check if land rate is visible
                    _landRateVisible = _quarry?.LandRateFee > 0;

                    // Sync the sale date to fix date picker validation issue
                    // This ensures _sale.SaleDate is properly set from the picker values
                    if (_saleDate.HasValue && _saleTime.HasValue)
                    {
                        _sale.SaleDate = _saleDate.Value.Date.Add(_saleTime.Value);
                    }
                    else if (_saleDate.HasValue)
                    {
                        _sale.SaleDate = _saleDate.Value;
                    }

                    // Check for prepaymentId in query string
                    var uri = new Uri(NavigationManager.Uri);
                    if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("prepaymentId", out var prepaymentIdValue))
                    {
                        var prepaymentId = prepaymentIdValue.FirstOrDefault();
                        if (!string.IsNullOrWhiteSpace(prepaymentId))
                        {
                            await LoadPrepaymentByIdAsync(prepaymentId);
                        }
                    }
                }
                else
                {
                    Snackbar.Add("No quarry assigned to your account. Please contact your manager.", Severity.Warning);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnProductChanged(string productId)
    {
        // Update the sale's product ID
        _sale.ProductId = productId;

        if (!string.IsNullOrWhiteSpace(productId) && !string.IsNullOrWhiteSpace(_quarryId))
        {
            try
            {
                // Get product to check if land rate should be auto-disabled
                var product = _products.FirstOrDefault(p => p.Id == productId);
                var productName = product?.ProductName?.ToLower() ?? "";

                // Auto-set land rate to OFF (value = 0) for Beam, Hardcore, or Reject products
                // Clerk can still manually enable it if needed
                if (productName.Contains("beam") ||
                    productName.Contains("hardcore") ||
                    productName.Contains("reject"))
                {
                    _sale.IncludeLandRate = false;
                }

                // Auto-load price for this product at this quarry
                var productPrice = await SaleService.GetProductPriceAsync(productId, _quarryId);
                if (productPrice != null)
                {
                    _sale.PricePerUnit = productPrice.Price;
                }
                else
                {
                    _sale.PricePerUnit = 0;
                }

                // Trigger order summary recalculation
                CalculateOrderSummary();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading product price: {ex.Message}", Severity.Error);
            }
        }
    }

    private void CalculateOrderSummary()
    {
        // Sync sale date and time
        if (_saleDate.HasValue && _saleTime.HasValue)
        {
            _sale.SaleDate = _saleDate.Value.Date.Add(_saleTime.Value);
        }
        else if (_saleDate.HasValue)
        {
            _sale.SaleDate = _saleDate.Value;
        }

        // Get selected product name for land rate calculation
        var selectedProduct = _products.FirstOrDefault(p => p.Id == _sale.ProductId);
        var productName = selectedProduct?.ProductName ?? "";

        // Calculate all amounts (respecting land rate inclusion flag)
        // Don't apply loaders fee for beam or hardcore products
        var loadersFee = (productName.Contains("beam", StringComparison.OrdinalIgnoreCase) ||
                         productName.Contains("hardcore", StringComparison.OrdinalIgnoreCase))
            ? null
            : _quarry?.LoadersFee;

        _calculations = CalculationService.CalculateAll(
            _sale.Quantity,
            _sale.PricePerUnit,
            _sale.CommissionPerUnit,
            productName,
            loadersFee,
            _quarry?.LandRateFee,
            _quarry?.RejectsFee,
            _sale.IncludeLandRate
        );

        StateHasChanged();
    }

    private void OnLandRateToggleChanged(bool value)
    {
        _sale.IncludeLandRate = value;
        CalculateOrderSummary();
    }

    private void OnSaleDateChanged(DateTime? date)
    {
        _saleDate = date;
        SyncSaleDateTime();
    }

    private void OnSaleTimeChanged(TimeSpan? time)
    {
        _saleTime = time;
        SyncSaleDateTime();
    }

    private void SyncSaleDateTime()
    {
        if (_saleDate.HasValue && _saleTime.HasValue)
        {
            _sale.SaleDate = _saleDate.Value.Date.Add(_saleTime.Value);
        }
        else if (_saleDate.HasValue)
        {
            _sale.SaleDate = _saleDate.Value;
        }
        CalculateOrderSummary();
    }

    private async Task LoadPrepaymentByIdAsync(string prepaymentId)
    {
        try
        {
            var prepayment = await PrepaymentService.GetPrepaymentAsync(prepaymentId);
            if (prepayment != null && (prepayment.Status == "Active" || prepayment.Status == "Partial"))
            {
                await SelectPrepayment(prepayment);
            }
            else if (prepayment != null)
            {
                Snackbar.Add($"Prepayment is {prepayment.Status} and cannot be used", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading prepayment: {ex.Message}", Severity.Error);
        }
    }

    private async Task SearchPrepayments()
    {
        if (string.IsNullOrWhiteSpace(_vehicleSearchQuery) || _vehicleSearchQuery.Length < 2)
        {
            _availablePrepayments.Clear();
            return;
        }

        _searchingPrepayments = true;
        try
        {
            _availablePrepayments = await PrepaymentService.SearchPrepaymentsByVehicleAsync(
                _vehicleSearchQuery, _quarryId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error searching prepayments: {ex.Message}", Severity.Error);
            _availablePrepayments.Clear();
        }
        finally
        {
            _searchingPrepayments = false;
        }
    }

    private async Task SelectPrepayment(Prepayment prepayment)
    {
        _selectedPrepayment = prepayment;

        // Auto-fill vehicle registration if empty
        if (string.IsNullOrWhiteSpace(_sale.VehicleRegistration))
        {
            _sale.VehicleRegistration = prepayment.VehicleRegistration;
        }

        // Auto-fill client details if available
        if (!string.IsNullOrWhiteSpace(prepayment.ClientName))
        {
            _sale.ClientName = prepayment.ClientName;
            _sale.ClientPhone = prepayment.ClientPhone;
        }

        // If intended product specified, pre-select it
        if (!string.IsNullOrWhiteSpace(prepayment.IntendedProductId))
        {
            _sale.ProductId = prepayment.IntendedProductId;
            await OnProductChanged(prepayment.IntendedProductId);

            // Calculate suggested quantity based on remaining balance
            if (prepayment.IntendedPricePerUnit.HasValue && prepayment.IntendedPricePerUnit > 0)
            {
                _estimatedQuantity = Math.Floor(prepayment.RemainingBalance / prepayment.IntendedPricePerUnit.Value);
                _sale.Quantity = _estimatedQuantity;
            }
        }

        CalculateOrderSummary();
        StateHasChanged();
    }

    private void ClearPrepayment()
    {
        _selectedPrepayment = null;
        _availablePrepayments.Clear();
        _vehicleSearchQuery = "";
        _estimatedQuantity = 0;
        CalculateOrderSummary();
        StateHasChanged();
    }

    private async Task SubmitSale()
    {
        // Sync sale date and time
        if (_saleDate.HasValue && _saleTime.HasValue)
        {
            _sale.SaleDate = _saleDate.Value.Date.Add(_saleTime.Value);
        }
        else if (_saleDate.HasValue)
        {
            _sale.SaleDate = _saleDate.Value;
        }

        // Build confirmation message
        var selectedProduct = _products.FirstOrDefault(p => p.Id == _sale.ProductId);
        var confirmMessage = $"Submit '{_sale.VehicleRegistration} - {selectedProduct?.ProductName}' {_sale.Quantity:N0} pieces?";

        // Add prepayment details to confirmation if applicable
        if (_selectedPrepayment != null)
        {
            confirmMessage += $"\n\nPrepayment Applied: KES {PrepaymentAppliedAmount:N0}";
            if (BalanceDue > 0)
            {
                confirmMessage += $"\nBalance Due: KES {BalanceDue:N0}";
            }
            else
            {
                confirmMessage += $"\nFully paid by prepayment";
            }
        }

        var result = await DialogService.ShowMessageBox(
            "Confirm Sale",
            confirmMessage,
            yesText: "Submit", cancelText: "Cancel");

        if (result != true)
            return;

        _processing = true;
        try
        {
            // Prepare prepayment parameters
            string? prepaymentId = _selectedPrepayment?.Id;
            double prepaymentAmount = PrepaymentAppliedAmount;

            // Create the sale (with or without prepayment)
            var (success, message, sale) = await SaleService.CreateSaleAsync(
                _sale, _userId, _quarryId, _userFullName, prepaymentId, prepaymentAmount);

            if (success && sale != null)
            {
                // If prepayment was applied, update the prepayment record
                if (!string.IsNullOrEmpty(prepaymentId) && prepaymentAmount > 0)
                {
                    var (prepaymentSuccess, prepaymentMessage) = await PrepaymentService.ApplyPrepaymentToSaleAsync(
                        prepaymentId, sale.Id, prepaymentAmount);

                    if (!prepaymentSuccess)
                    {
                        // Sale was created but prepayment application failed
                        Snackbar.Add($"Sale created but prepayment update failed: {prepaymentMessage}", Severity.Warning);
                    }
                    else
                    {
                        // Success with prepayment
                        var successMsg = $"Sale recorded successfully";
                        if (BalanceDue > 0)
                        {
                            successMsg += $". Balance due: KES {BalanceDue:N0}";
                        }
                        Snackbar.Add(successMsg, Severity.Success);
                    }
                }
                else
                {
                    // Success without prepayment
                    Snackbar.Add(message, Severity.Success);
                }

                // Navigate to dashboard
                NavigationManager.NavigateTo("/clerk/dashboard");
            }
            else
            {
                Snackbar.Add(message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error submitting sale: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/clerk/dashboard");
    }

    private async Task<IEnumerable<string>> SearchCounties(string value, CancellationToken token)
    {
        await Task.Delay(5, token); // Small delay for responsiveness

        if (string.IsNullOrWhiteSpace(value))
            return KenyaCounties;

        return KenyaCounties.Where(c => c.Contains(value, StringComparison.OrdinalIgnoreCase));
    }
}
