@page "/manager/accounting/journal-entries"
@page "/admin/accounting/journal-entries"
@using QDeskPro.Data
@using QDeskPro.Domain.Entities
@using QDeskPro.Features.Accounting.Services
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using MudBlazor
@inject AppDbContext DbContext
@inject IAccountingService AccountingService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@attribute [Authorize(Policy = "RequireManagerOrAdmin")]
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Journal Entries - QDeskPro</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4 mb-8">
    <MudStack Spacing="4">
        @* Header *@
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudBreadcrumbs Items="_breadcrumbs" Class="pa-0" />
                <MudText Typo="Typo.h4" Class="fw-bold mt-2">
                    <MudIcon Icon="@Icons.Material.Filled.MenuBook" Class="mr-2" Style="vertical-align: middle;" />
                    Journal Entries
                </MudText>
                <MudText Typo="Typo.body2" Class="text-muted">
                    View auto-generated double-entry journal entries from transactions
                </MudText>
            </div>
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.Refresh" OnClick="RegenerateEntries"
                          Disabled="_regenerating">
                    @if (_regenerating) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                    Regenerate Entries
                </MudButton>
            </MudStack>
        </MudStack>

        @* Filters *@
        <MudPaper Elevation="0" Class="pa-4 rounded-lg" Style="background: var(--mud-palette-background-gray);">
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="string" @bind-Value="_selectedQuarryId" Label="Quarry"
                              Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Dense="true">
                        @foreach (var quarry in _quarries)
                        {
                            <MudSelectItem T="string" Value="@quarry.Id">@quarry.QuarryName</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6" md="2">
                    <MudDatePicker @bind-Date="_fromDate" Label="From Date"
                                  Variant="Variant.Outlined" MaxDate="DateTime.Today" Dense="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="2">
                    <MudDatePicker @bind-Date="_toDate" Label="To Date"
                                  Variant="Variant.Outlined" MinDate="_fromDate" MaxDate="DateTime.Today" Dense="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="2">
                    <MudSelect T="string" @bind-Value="_entryTypeFilter" Label="Entry Type"
                              Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Dense="true">
                        <MudSelectItem T="string" Value="@("")">All Types</MudSelectItem>
                        <MudSelectItem T="string" Value="@("Auto")">Auto-generated</MudSelectItem>
                        <MudSelectItem T="string" Value="@("Manual")">Manual</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6" md="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                              OnClick="LoadEntries" Disabled="_loading || string.IsNullOrEmpty(_selectedQuarryId)"
                              StartIcon="@Icons.Material.Filled.Search" Style="height: 40px;">
                        @if (_loading) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                        Load
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>

        @* Summary Cards *@
        @if (_entries.Any())
        {
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4 rounded-lg" Elevation="2">
                        <MudText Typo="Typo.body2" Class="text-muted">Total Entries</MudText>
                        <MudText Typo="Typo.h5" Class="fw-bold">@_entries.Count</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4 rounded-lg" Elevation="2">
                        <MudText Typo="Typo.body2" Class="text-muted">Total Debits</MudText>
                        <MudText Typo="Typo.h5" Class="fw-bold" Color="Color.Success">
                            KES @_entries.SelectMany(e => e.Lines).Sum(l => l.DebitAmount).ToString("N0")
                        </MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4 rounded-lg" Elevation="2">
                        <MudText Typo="Typo.body2" Class="text-muted">Total Credits</MudText>
                        <MudText Typo="Typo.h5" Class="fw-bold" Color="Color.Error">
                            KES @_entries.SelectMany(e => e.Lines).Sum(l => l.CreditAmount).ToString("N0")
                        </MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4 rounded-lg" Elevation="2">
                        <MudText Typo="Typo.body2" Class="text-muted">Auto-Generated</MudText>
                        <MudText Typo="Typo.h5" Class="fw-bold">
                            @_entries.Count(e => e.EntryType == "Auto") entries
                        </MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        }

        @* Journal Entries Table *@
        @if (_entries.Any())
        {
            <MudPaper Class="pa-4 rounded-lg" Elevation="2">
                <MudTable Items="@_entries" Dense="true" Hover="true" Bordered="true"
                         FixedHeader="true" Height="500px"
                         T="JournalEntry" OnRowClick="@((TableRowClickEventArgs<JournalEntry> args) => ToggleEntryDetails(args.Item))">
                    <HeaderContent>
                        <MudTh Style="width: 120px;">Date</MudTh>
                        <MudTh Style="width: 120px;">Reference</MudTh>
                        <MudTh>Description</MudTh>
                        <MudTh Style="width: 100px;">Type</MudTh>
                        <MudTh Style="width: 100px;">Source</MudTh>
                        <MudTh Style="text-align: right; width: 120px;">Debit</MudTh>
                        <MudTh Style="text-align: right; width: 120px;">Credit</MudTh>
                        <MudTh Style="width: 80px;">Posted</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Date">@context.EntryDate.ToString("dd/MM/yyyy")</MudTd>
                        <MudTd DataLabel="Reference">
                            <MudText Typo="Typo.body2" Style="font-family: monospace;">@context.Reference</MudText>
                        </MudTd>
                        <MudTd DataLabel="Description">
                            <MudText Typo="Typo.body2">@context.Description</MudText>
                        </MudTd>
                        <MudTd DataLabel="Type">
                            <MudChip T="string" Size="Size.Small" Color="@(context.EntryType == "Auto" ? Color.Info : Color.Warning)">
                                @context.EntryType
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Source">
                            <MudText Typo="Typo.caption">@(context.SourceEntityType ?? "-")</MudText>
                        </MudTd>
                        <MudTd DataLabel="Debit" Style="text-align: right;">
                            <MudText Typo="Typo.body2" Color="Color.Success">
                                @context.Lines.Sum(l => l.DebitAmount).ToString("N0")
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="Credit" Style="text-align: right;">
                            <MudText Typo="Typo.body2" Color="Color.Error">
                                @context.Lines.Sum(l => l.CreditAmount).ToString("N0")
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="Posted">
                            @if (context.IsPosted)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Pending" Color="Color.Warning" Size="Size.Small" />
                            }
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        }
        else if (!_loading && _hasSearched)
        {
            <MudPaper Class="pa-8 text-center rounded-lg" Elevation="0" Style="background: var(--mud-palette-background-gray);">
                <MudIcon Icon="@Icons.Material.Filled.SearchOff" Style="font-size: 64px;" Color="Color.Warning" />
                <MudText Typo="Typo.h6" Class="mt-4">No journal entries found</MudText>
                <MudText Typo="Typo.body2" Class="text-muted">
                    Try adjusting your date range or click "Regenerate Entries" to create entries from transactions
                </MudText>
            </MudPaper>
        }
        else if (!_hasSearched)
        {
            <MudPaper Class="pa-8 text-center rounded-lg" Elevation="0" Style="background: var(--mud-palette-background-gray);">
                <MudIcon Icon="@Icons.Material.Filled.MenuBook" Style="font-size: 64px;" Color="Color.Warning" />
                <MudText Typo="Typo.h6" Class="mt-4">Select a quarry and date range to view journal entries</MudText>
                <MudText Typo="Typo.body2" Class="text-muted">
                    Journal entries are automatically generated from sales, expenses, and banking transactions
                </MudText>
            </MudPaper>
        }

        @* Selected Entry Details *@
        @if (_selectedEntry != null)
        {
            <MudPaper Class="pa-4 rounded-lg" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" Style="vertical-align: middle;" />
                        Entry Details: @_selectedEntry.Reference
                    </MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="() => _selectedEntry = null" />
                </MudStack>

                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudSimpleTable Dense="true" Bordered="true">
                            <tbody>
                                <tr>
                                    <td style="width: 150px;"><strong>Date</strong></td>
                                    <td>@_selectedEntry.EntryDate.ToString("MMMM dd, yyyy")</td>
                                </tr>
                                <tr>
                                    <td><strong>Reference</strong></td>
                                    <td style="font-family: monospace;">@_selectedEntry.Reference</td>
                                </tr>
                                <tr>
                                    <td><strong>Description</strong></td>
                                    <td>@_selectedEntry.Description</td>
                                </tr>
                                <tr>
                                    <td><strong>Entry Type</strong></td>
                                    <td>@_selectedEntry.EntryType</td>
                                </tr>
                                <tr>
                                    <td><strong>Source</strong></td>
                                    <td>@(_selectedEntry.SourceEntityType ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <td><strong>Posted</strong></td>
                                    <td>@(_selectedEntry.IsPosted ? $"Yes - {_selectedEntry.PostedDate?.ToString("dd/MM/yyyy")}" : "No")</td>
                                </tr>
                            </tbody>
                        </MudSimpleTable>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Journal Entry Lines</MudText>
                        <MudTable Items="@_selectedEntry.Lines" Dense="true" Bordered="true">
                            <HeaderContent>
                                <MudTh>Account</MudTh>
                                <MudTh Style="text-align: right;">Debit</MudTh>
                                <MudTh Style="text-align: right;">Credit</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Account">
                                    <MudText Typo="Typo.body2">
                                        <strong>@context.LedgerAccount?.AccountCode</strong> - @context.LedgerAccount?.AccountName
                                    </MudText>
                                    @if (!string.IsNullOrEmpty(context.Memo))
                                    {
                                        <MudText Typo="Typo.caption" Class="text-muted">@context.Memo</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Debit" Style="text-align: right;">
                                    @if (context.DebitAmount > 0)
                                    {
                                        <MudText Color="Color.Success">@context.DebitAmount.ToString("N2")</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Credit" Style="text-align: right;">
                                    @if (context.CreditAmount > 0)
                                    {
                                        <MudText Color="Color.Error">@context.CreditAmount.ToString("N2")</MudText>
                                    }
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-2">
                            <MudText Typo="Typo.body2" Class="fw-bold">
                                Total: Debit @_selectedEntry.Lines.Sum(l => l.DebitAmount).ToString("N2") |
                                Credit @_selectedEntry.Lines.Sum(l => l.CreditAmount).ToString("N2")
                            </MudText>
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }

        @* Help Info *@
        <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info">
            <MudText Typo="Typo.body2">
                <strong>About Journal Entries:</strong> Journal entries are automatically created from sales, expenses, and banking
                transactions using double-entry bookkeeping principles. Each transaction creates balanced entries where
                total debits equal total credits.
            </MudText>
        </MudAlert>
    </MudStack>
</MudContainer>

@code {
    [CascadingParameter] private Task<AuthenticationState>? AuthStateTask { get; set; }

    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Accounting", "/manager/accounting", false, Icons.Material.Filled.AccountBalance),
        new BreadcrumbItem("Journal Entries", null, true)
    };

    private List<Quarry> _quarries = new();
    private List<JournalEntry> _entries = new();
    private JournalEntry? _selectedEntry;
    private string? _selectedQuarryId;
    private DateTime? _fromDate = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
    private DateTime? _toDate = DateTime.Today;
    private string _entryTypeFilter = "";
    private string? _userId;
    private string? _userRole;
    private bool _loading;
    private bool _regenerating;
    private bool _hasSearched;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();
        await LoadQuarries();
    }

    private async Task LoadUserInfo()
    {
        if (AuthStateTask != null)
        {
            var authState = await AuthStateTask;
            _userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            _userRole = authState.User.FindFirst(ClaimTypes.Role)?.Value;
        }
    }

    private async Task LoadQuarries()
    {
        try
        {
            if (_userRole == "Administrator")
            {
                _quarries = await DbContext.Quarries.Where(q => q.IsActive).OrderBy(q => q.QuarryName).ToListAsync();
            }
            else
            {
                var owned = await DbContext.Quarries.Where(q => q.ManagerId == _userId && q.IsActive).ToListAsync();
                var assignedIds = await DbContext.UserQuarries.Where(uq => uq.UserId == _userId).Select(uq => uq.QuarryId).ToListAsync();
                var assigned = await DbContext.Quarries.Where(q => assignedIds.Contains(q.Id) && q.IsActive).ToListAsync();
                _quarries = owned.Union(assigned).Distinct().OrderBy(q => q.QuarryName).ToList();
            }
            if (_quarries.Count == 1 && string.IsNullOrEmpty(_selectedQuarryId)) _selectedQuarryId = _quarries[0].Id;
        }
        catch (Exception ex) { Snackbar.Add($"Error loading quarries: {ex.Message}", Severity.Error); }
    }

    private async Task LoadEntries()
    {
        if (string.IsNullOrEmpty(_selectedQuarryId) || !_fromDate.HasValue || !_toDate.HasValue) return;

        _loading = true;
        _hasSearched = true;
        _selectedEntry = null;
        try
        {
            var query = DbContext.JournalEntries
                .Include(j => j.Lines)
                    .ThenInclude(l => l.LedgerAccount)
                .Where(j => j.QId == _selectedQuarryId && j.IsActive)
                .Where(j => j.EntryDate >= _fromDate.Value && j.EntryDate <= _toDate.Value);

            if (!string.IsNullOrEmpty(_entryTypeFilter))
            {
                query = query.Where(j => j.EntryType == _entryTypeFilter);
            }

            _entries = await query
                .OrderByDescending(j => j.EntryDate)
                .ThenByDescending(j => j.DateCreated)
                .ToListAsync();
        }
        catch (Exception ex) { Snackbar.Add($"Error loading entries: {ex.Message}", Severity.Error); }
        finally { _loading = false; }
    }

    private async Task RegenerateEntries()
    {
        if (string.IsNullOrEmpty(_selectedQuarryId))
        {
            Snackbar.Add("Please select a quarry first", Severity.Warning);
            return;
        }

        var confirmed = await DialogService.ShowMessageBox(
            "Regenerate Journal Entries",
            "This will regenerate all journal entries from transactions. Existing auto-generated entries will be replaced. Continue?",
            yesText: "Regenerate", cancelText: "Cancel");

        if (confirmed != true) return;

        _regenerating = true;
        try
        {
            await AccountingService.RegenerateAllJournalEntriesAsync(_selectedQuarryId, _fromDate!.Value, _toDate!.Value);
            Snackbar.Add("Journal entries regenerated successfully", Severity.Success);
            await LoadEntries();
        }
        catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
        finally { _regenerating = false; }
    }

    private void ToggleEntryDetails(JournalEntry entry)
    {
        if (_selectedEntry?.Id == entry.Id)
            _selectedEntry = null;
        else
            _selectedEntry = entry;
    }
}
