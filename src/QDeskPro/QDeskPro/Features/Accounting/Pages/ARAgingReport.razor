@page "/manager/accounting/ar-aging"
@page "/admin/accounting/ar-aging"
@using QDeskPro.Data
@using QDeskPro.Domain.Entities
@using QDeskPro.Features.Accounting.Services
@using QDeskPro.Features.Accounting.Models
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@inject AppDbContext DbContext
@inject IFinancialReportService ReportService
@inject IFinancialReportExportService ExportService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@attribute [Authorize(Policy = "RequireManagerOrAdmin")]
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>AR Aging Report - QDeskPro</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4 mb-8">
    <MudStack Spacing="4">
        @* Header *@
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudBreadcrumbs Items="_breadcrumbs" Class="pa-0" />
                <MudText Typo="Typo.h4" Class="fw-bold mt-2">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Class="mr-2" Style="vertical-align: middle;" />
                    Accounts Receivable Aging
                </MudText>
                <MudText Typo="Typo.body2" Class="text-muted">
                    Unpaid customer sales grouped by age for collection management
                </MudText>
            </div>
            @if (_report != null)
            {
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.PictureAsPdf" OnClick="ExportToPdf" Disabled="_exporting">
                        Export PDF
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Success"
                              StartIcon="@Icons.Material.Filled.TableChart" OnClick="ExportToExcel" Disabled="_exporting">
                        Export Excel
                    </MudButton>
                </MudStack>
            }
        </MudStack>

        @* Filters *@
        <MudPaper Elevation="0" Class="pa-4 rounded-lg" Style="background: var(--mud-palette-background-gray);">
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="string" @bind-Value="_selectedQuarryId" Label="Quarry"
                              Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Dense="true">
                        @foreach (var quarry in _quarries)
                        {
                            <MudSelectItem T="string" Value="@quarry.Id">@quarry.QuarryName</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6" md="2">
                    <MudDatePicker @bind-Date="_asOfDate" Label="As of Date"
                                  Variant="Variant.Outlined" MaxDate="DateTime.Today" Dense="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                              OnClick="GenerateReport" Disabled="_loading || string.IsNullOrEmpty(_selectedQuarryId)"
                              StartIcon="@Icons.Material.Filled.PlayArrow" Style="height: 40px;">
                        @if (_loading) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                        Generate
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>

        @* Report Content *@
        @if (_report != null)
        {
            @* Summary Cards *@
            <MudGrid>
                <MudItem xs="12" sm="6" md="2">
                    <MudPaper Class="pa-4 rounded-lg" Elevation="2" Style="border-left: 4px solid var(--mud-palette-success);">
                        <MudText Typo="Typo.body2" Class="text-muted">Current</MudText>
                        <MudText Typo="Typo.h6" Class="fw-bold" Color="Color.Success">KES @_report.TotalCurrent.ToString("N0")</MudText>
                        <MudText Typo="Typo.caption" Class="text-muted">@_report.CurrentPercentage.ToString("F1")%</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="2">
                    <MudPaper Class="pa-4 rounded-lg" Elevation="2" Style="border-left: 4px solid var(--mud-palette-info);">
                        <MudText Typo="Typo.body2" Class="text-muted">1-30 Days</MudText>
                        <MudText Typo="Typo.h6" Class="fw-bold" Color="Color.Info">KES @_report.Total1To30Days.ToString("N0")</MudText>
                        <MudText Typo="Typo.caption" Class="text-muted">@_report.Days1To30Percentage.ToString("F1")%</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="2">
                    <MudPaper Class="pa-4 rounded-lg" Elevation="2" Style="border-left: 4px solid var(--mud-palette-warning);">
                        <MudText Typo="Typo.body2" Class="text-muted">31-60 Days</MudText>
                        <MudText Typo="Typo.h6" Class="fw-bold" Color="Color.Warning">KES @_report.Total31To60Days.ToString("N0")</MudText>
                        <MudText Typo="Typo.caption" Class="text-muted">@_report.Days31To60Percentage.ToString("F1")%</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="2">
                    <MudPaper Class="pa-4 rounded-lg" Elevation="2" Style="border-left: 4px solid var(--mud-palette-error);">
                        <MudText Typo="Typo.body2" Class="text-muted">61-90 Days</MudText>
                        <MudText Typo="Typo.h6" Class="fw-bold" Color="Color.Error">KES @_report.Total61To90Days.ToString("N0")</MudText>
                        <MudText Typo="Typo.caption" Class="text-muted">@_report.Days61To90Percentage.ToString("F1")%</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="2">
                    <MudPaper Class="pa-4 rounded-lg" Elevation="2" Style="border-left: 4px solid #9C27B0;">
                        <MudText Typo="Typo.body2" Class="text-muted">90+ Days</MudText>
                        <MudText Typo="Typo.h6" Class="fw-bold" Style="color: #9C27B0;">KES @_report.TotalOver90Days.ToString("N0")</MudText>
                        <MudText Typo="Typo.caption" Class="text-muted">@_report.Over90Percentage.ToString("F1")%</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="2">
                    <MudPaper Class="pa-4 rounded-lg" Elevation="2" Style="border-left: 4px solid var(--mud-palette-primary);">
                        <MudText Typo="Typo.body2" Class="text-muted">Total Outstanding</MudText>
                        <MudText Typo="Typo.h6" Class="fw-bold" Color="Color.Primary">KES @_report.TotalOutstanding.ToString("N0")</MudText>
                        <MudText Typo="Typo.caption" Class="text-muted">100%</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            @* Aging Chart *@
            <MudPaper Class="pa-4 rounded-lg" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">Aging Distribution</MudText>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.End" Style="height: 200px;">
                    @{
                        var maxValue = new[] { _report.TotalCurrent, _report.Total1To30Days, _report.Total31To60Days, _report.Total61To90Days, _report.TotalOver90Days }.Max();
                        var buckets = new[] {
                            ("Current", _report.TotalCurrent, "var(--mud-palette-success)"),
                            ("1-30 Days", _report.Total1To30Days, "var(--mud-palette-info)"),
                            ("31-60 Days", _report.Total31To60Days, "var(--mud-palette-warning)"),
                            ("61-90 Days", _report.Total61To90Days, "var(--mud-palette-error)"),
                            ("90+ Days", _report.TotalOver90Days, "#9C27B0")
                        };
                    }
                    @foreach (var bucket in buckets)
                    {
                        var height = maxValue > 0 ? (bucket.Item2 / maxValue * 180) : 0;
                        <MudStack AlignItems="AlignItems.Center" Style="flex: 1;">
                            <div style="height: @(height)px; width: 100%; max-width: 80px; background: @bucket.Item3; border-radius: 4px 4px 0 0;"></div>
                            <MudText Typo="Typo.caption" Class="text-center">@bucket.Item1</MudText>
                        </MudStack>
                    }
                </MudStack>
            </MudPaper>

            @* Customer Details Table *@
            <MudPaper Class="pa-4 rounded-lg" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">Customer Details</MudText>
                @if (_report.Customers.Any())
                {
                    <MudTable Items="@_report.Customers" Dense="true" Hover="true" Bordered="true" Striped="true"
                             FixedHeader="true" Height="400px">
                        <HeaderContent>
                            <MudTh>Customer</MudTh>
                            <MudTh>Phone</MudTh>
                            <MudTh Style="text-align: right;">Current</MudTh>
                            <MudTh Style="text-align: right;">1-30 Days</MudTh>
                            <MudTh Style="text-align: right;">31-60 Days</MudTh>
                            <MudTh Style="text-align: right;">61-90 Days</MudTh>
                            <MudTh Style="text-align: right;">90+ Days</MudTh>
                            <MudTh Style="text-align: right; font-weight: bold;">Total</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Customer">
                                <MudText Typo="Typo.body2" Class="fw-bold">@context.VehicleRegistration</MudText>
                                @if (!string.IsNullOrEmpty(context.ClientName))
                                {
                                    <MudText Typo="Typo.caption" Class="text-muted">@context.ClientName</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="Phone">@(context.ClientPhone ?? "-")</MudTd>
                            <MudTd DataLabel="Current" Style="text-align: right;">
                                @if (context.CurrentAmount > 0) { <span style="color: var(--mud-palette-success);">@context.CurrentAmount.ToString("N0")</span> } else { <span>-</span> }
                            </MudTd>
                            <MudTd DataLabel="1-30 Days" Style="text-align: right;">
                                @if (context.Days1To30Amount > 0) { <span style="color: var(--mud-palette-info);">@context.Days1To30Amount.ToString("N0")</span> } else { <span>-</span> }
                            </MudTd>
                            <MudTd DataLabel="31-60 Days" Style="text-align: right;">
                                @if (context.Days31To60Amount > 0) { <span style="color: var(--mud-palette-warning);">@context.Days31To60Amount.ToString("N0")</span> } else { <span>-</span> }
                            </MudTd>
                            <MudTd DataLabel="61-90 Days" Style="text-align: right;">
                                @if (context.Days61To90Amount > 0) { <span style="color: var(--mud-palette-error);">@context.Days61To90Amount.ToString("N0")</span> } else { <span>-</span> }
                            </MudTd>
                            <MudTd DataLabel="90+ Days" Style="text-align: right;">
                                @if (context.Over90DaysAmount > 0) { <span style="color: #9C27B0;">@context.Over90DaysAmount.ToString("N0")</span> } else { <span>-</span> }
                            </MudTd>
                            <MudTd DataLabel="Total" Style="text-align: right; font-weight: bold;">
                                KES @context.TotalAmount.ToString("N0")
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else
                {
                    <MudAlert Severity="Severity.Success" Class="mt-3">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
                        No unpaid sales! All customers are current.
                    </MudAlert>
                }
            </MudPaper>

            @* Invoice Details (Expandable) *@
            @if (_report.Invoices.Any())
            {
                <MudExpansionPanels>
                    <MudExpansionPanel Text="@($"Invoice Details ({_report.Invoices.Count} unpaid invoices)")">
                        <MudTable Items="@_report.Invoices" Dense="true" Hover="true" Bordered="true">
                            <HeaderContent>
                                <MudTh>Date</MudTh>
                                <MudTh>Customer</MudTh>
                                <MudTh>Product</MudTh>
                                <MudTh Style="text-align: right;">Qty</MudTh>
                                <MudTh Style="text-align: right;">Amount</MudTh>
                                <MudTh Style="text-align: right;">Days Overdue</MudTh>
                                <MudTh>Age Bucket</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Date">@context.InvoiceDate.ToString("dd/MM/yyyy")</MudTd>
                                <MudTd DataLabel="Customer">@context.VehicleRegistration</MudTd>
                                <MudTd DataLabel="Product">@context.ProductName</MudTd>
                                <MudTd DataLabel="Qty" Style="text-align: right;">@context.Quantity.ToString("N0")</MudTd>
                                <MudTd DataLabel="Amount" Style="text-align: right;">KES @context.Amount.ToString("N0")</MudTd>
                                <MudTd DataLabel="Days Overdue" Style="text-align: right;">@context.DaysOverdue</MudTd>
                                <MudTd DataLabel="Age Bucket">
                                    <MudChip T="string" Size="Size.Small" Color="@GetAgeBucketColor(context.AgeBucket)">
                                        @context.AgeBucket
                                    </MudChip>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }

            <MudText Typo="Typo.caption" Class="text-muted text-center">
                Report generated on @_report.GeneratedAt.ToString("MMMM dd, yyyy HH:mm") | @_report.QuarryName | As of @_report.AsOfDate.ToString("MMMM dd, yyyy")
            </MudText>
        }
        else if (!_loading)
        {
            <MudPaper Class="pa-8 text-center rounded-lg" Elevation="0" Style="background: var(--mud-palette-background-gray);">
                <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Style="font-size: 64px;" Color="Color.Warning" />
                <MudText Typo="Typo.h6" Class="mt-4">Select a quarry and date to generate the AR Aging Report</MudText>
                <MudText Typo="Typo.body2" Class="text-muted">
                    This report shows unpaid customer balances grouped by age for collection management
                </MudText>
            </MudPaper>
        }
    </MudStack>
</MudContainer>

@code {
    [CascadingParameter] private Task<AuthenticationState>? AuthStateTask { get; set; }
    [SupplyParameterFromQuery] public string? QuarryId { get; set; }

    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Accounting", "/manager/accounting", false, Icons.Material.Filled.AccountBalance),
        new BreadcrumbItem("AR Aging", null, true)
    };

    private List<Quarry> _quarries = new();
    private string? _selectedQuarryId;
    private DateTime? _asOfDate = DateTime.Today;
    private string? _userId;
    private string? _userRole;
    private bool _loading;
    private bool _exporting;
    private QDeskPro.Features.Accounting.Models.ARAgingReport? _report;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();
        await LoadQuarries();
        if (!string.IsNullOrEmpty(QuarryId)) _selectedQuarryId = QuarryId;
    }

    private async Task LoadUserInfo()
    {
        if (AuthStateTask != null)
        {
            var authState = await AuthStateTask;
            _userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            _userRole = authState.User.FindFirst(ClaimTypes.Role)?.Value;
        }
    }

    private async Task LoadQuarries()
    {
        try
        {
            if (_userRole == "Administrator")
            {
                _quarries = await DbContext.Quarries.Where(q => q.IsActive).OrderBy(q => q.QuarryName).ToListAsync();
            }
            else
            {
                var owned = await DbContext.Quarries.Where(q => q.ManagerId == _userId && q.IsActive).ToListAsync();
                var assignedIds = await DbContext.UserQuarries.Where(uq => uq.UserId == _userId).Select(uq => uq.QuarryId).ToListAsync();
                var assigned = await DbContext.Quarries.Where(q => assignedIds.Contains(q.Id) && q.IsActive).ToListAsync();
                _quarries = owned.Union(assigned).Distinct().OrderBy(q => q.QuarryName).ToList();
            }
            if (_quarries.Count == 1 && string.IsNullOrEmpty(_selectedQuarryId)) _selectedQuarryId = _quarries[0].Id;
        }
        catch (Exception ex) { Snackbar.Add($"Error loading quarries: {ex.Message}", Severity.Error); }
    }

    private async Task GenerateReport()
    {
        if (string.IsNullOrEmpty(_selectedQuarryId) || !_asOfDate.HasValue)
        {
            Snackbar.Add("Please select a quarry and date", Severity.Warning);
            return;
        }
        _loading = true;
        _report = null;
        try
        {
            _report = await ReportService.GenerateARAgingAsync(_selectedQuarryId, _asOfDate.Value);
            Snackbar.Add("AR Aging Report generated successfully", Severity.Success);
        }
        catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
        finally { _loading = false; }
    }

    private Color GetAgeBucketColor(string bucket) => bucket switch
    {
        "Current" => Color.Success,
        "1-30 Days" => Color.Info,
        "31-60 Days" => Color.Warning,
        "61-90 Days" => Color.Error,
        _ => Color.Secondary
    };

    private async Task ExportToPdf()
    {
        if (_report == null) return;
        _exporting = true;
        try
        {
            var bytes = ExportService.ExportARAgingToPdf(_report);
            var fileName = $"ARAgingReport_{_report.QuarryName}_{_report.AsOfDate:yyyyMMdd}.pdf";
            await DownloadFile(bytes, fileName, "application/pdf");
            Snackbar.Add("PDF exported successfully", Severity.Success);
        }
        catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
        finally { _exporting = false; }
    }

    private async Task ExportToExcel()
    {
        if (_report == null) return;
        _exporting = true;
        try
        {
            var bytes = ExportService.ExportARAgingToExcel(_report);
            var fileName = $"ARAgingReport_{_report.QuarryName}_{_report.AsOfDate:yyyyMMdd}.xlsx";
            await DownloadFile(bytes, fileName, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            Snackbar.Add("Excel exported successfully", Severity.Success);
        }
        catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
        finally { _exporting = false; }
    }

    private async Task DownloadFile(byte[] bytes, string fileName, string contentType)
    {
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFile", fileName, contentType, base64);
    }
}
