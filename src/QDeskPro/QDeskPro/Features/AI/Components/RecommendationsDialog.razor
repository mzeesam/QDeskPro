@using QDeskPro.Features.AI.Services
@using MudBlazor
@inject ISalesAnalyticsService AnalyticsService

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudAvatar Color="Color.Primary" Size="Size.Small">
                <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Size="Size.Small" />
            </MudAvatar>
            <MudText Typo="Typo.h6">AI Recommendations</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_loading)
        {
            <MudStack AlignItems="AlignItems.Center" Spacing="3" Class="py-8">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.body1">Generating recommendations...</MudText>
                <MudText Typo="Typo.caption" Class="text-muted">AI is analyzing your business data</MudText>
            </MudStack>
        }
        else if (_result?.Success == true)
        {
            @* Focus Area *@
            <MudPaper Elevation="0" Class="pa-4 rounded-lg mb-4 focus-area-card">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.CenterFocusStrong" Color="Color.Primary" />
                    <MudText Typo="Typo.subtitle1" Class="font-weight-bold">Focus Area</MudText>
                </MudStack>
                <MudText Typo="Typo.h5" Color="Color.Primary" Class="font-weight-bold mb-2">
                    @_result.FocusArea
                </MudText>
                <MudText Typo="Typo.body2" Class="text-muted">
                    @_result.TopOpportunity
                </MudText>
            </MudPaper>

            @* Unpaid Orders Alert *@
            @if (_result.UnpaidOrdersCount > 0)
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-4">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                        <div>
                            <strong>@_result.UnpaidOrdersCount unpaid orders</strong> totaling KES @_result.UnpaidOrdersAmount.ToString("N0")
                        </div>
                        <MudButton Variant="Variant.Text" Color="Color.Warning" Size="Size.Small">
                            Review
                        </MudButton>
                    </MudStack>
                </MudAlert>
            }

            @* Recommendations *@
            <MudText Typo="Typo.subtitle1" Class="font-weight-bold mb-3">Actionable Recommendations</MudText>
            <MudStack Spacing="3" Class="mb-4">
                @foreach (var rec in _result.Recommendations.OrderBy(r => GetPriorityOrder(r.Priority)))
                {
                    <MudPaper Elevation="0" Class="@($"pa-4 rounded-lg recommendation-card {GetPriorityClass(rec.Priority)}")">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start" Class="mb-2">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@GetPriorityIcon(rec.Priority)"
                                         Color="@GetPriorityColor(rec.Priority)"
                                         Size="Size.Small" />
                                <MudText Typo="Typo.subtitle2" Class="font-weight-bold">@rec.Title</MudText>
                            </MudStack>
                            <MudChip T="string" Size="Size.Small"
                                     Color="@GetPriorityColor(rec.Priority)"
                                     Variant="Variant.Outlined">
                                @rec.Priority.ToUpperInvariant()
                            </MudChip>
                        </MudStack>
                        <MudText Typo="Typo.body2" Class="mb-2">@rec.Action</MudText>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" Color="Color.Success" />
                            <MudText Typo="Typo.caption" Color="Color.Success">
                                Expected Impact: @rec.Impact
                            </MudText>
                        </MudStack>
                    </MudPaper>
                }
            </MudStack>

            @* Quick Actions *@
            <MudText Typo="Typo.subtitle1" Class="font-weight-bold mb-2">Quick Actions</MudText>
            <MudGrid Spacing="2" Class="mb-4">
                <MudItem xs="6">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Assessment"
                               Href="/reports">
                        View Reports
                    </MudButton>
                </MudItem>
                <MudItem xs="6">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.SmartToy"
                               Href="/ai-chat">
                        Ask AI
                    </MudButton>
                </MudItem>
            </MudGrid>

            <MudText Typo="Typo.caption" Class="text-muted text-center">
                Generated at @_result.GeneratedAt.ToLocalTime().ToString("g")
            </MudText>
        }
        else
        {
            <MudAlert Severity="Severity.Error">
                @(_result?.Error ?? "Failed to generate recommendations. Please try again.")
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Close</MudButton>
        <MudButton Color="Color.Primary" OnClick="RefreshAsync" Disabled="@_loading">
            <MudIcon Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" Class="mr-1" />
            Refresh
        </MudButton>
    </DialogActions>
</MudDialog>

<style>
    .focus-area-card {
        background: linear-gradient(135deg, rgba(25, 118, 210, 0.08) 0%, rgba(25, 118, 210, 0.02) 100%);
        border: 1px solid rgba(25, 118, 210, 0.3);
    }

    .recommendation-card {
        border: 1px solid var(--mud-palette-lines-default);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .recommendation-card:hover {
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .recommendation-card.high {
        border-left: 4px solid var(--mud-palette-error);
    }

    .recommendation-card.medium {
        border-left: 4px solid var(--mud-palette-warning);
    }

    .recommendation-card.low {
        border-left: 4px solid var(--mud-palette-info);
    }
</style>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public string? QuarryId { get; set; }

    [Parameter]
    public DateTime FromDate { get; set; }

    [Parameter]
    public DateTime ToDate { get; set; }

    private RecommendationsResult? _result;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadRecommendationsAsync();
    }

    private async Task LoadRecommendationsAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _result = await AnalyticsService.GetRecommendationsAsync(QuarryId, FromDate, ToDate);
        }
        catch (Exception)
        {
            _result = new RecommendationsResult { Success = false, Error = "An error occurred while generating recommendations" };
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshAsync()
    {
        await LoadRecommendationsAsync();
    }

    private void Cancel() => MudDialog.Cancel();

    private int GetPriorityOrder(string priority) => priority switch
    {
        "high" => 1,
        "medium" => 2,
        "low" => 3,
        _ => 4
    };

    private string GetPriorityIcon(string priority) => priority switch
    {
        "high" => Icons.Material.Filled.PriorityHigh,
        "medium" => Icons.Material.Filled.Remove,
        "low" => Icons.Material.Filled.ArrowDownward,
        _ => Icons.Material.Filled.Help
    };

    private Color GetPriorityColor(string priority) => priority switch
    {
        "high" => Color.Error,
        "medium" => Color.Warning,
        "low" => Color.Info,
        _ => Color.Default
    };

    private string GetPriorityClass(string priority) => priority switch
    {
        "high" => "high",
        "medium" => "medium",
        "low" => "low",
        _ => ""
    };
}
