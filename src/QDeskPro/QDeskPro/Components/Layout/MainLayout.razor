@inherits LayoutComponentBase
@using MudBlazor
@using QDeskPro.Shared
@using QDeskPro.Shared.Components
@using QDeskPro.Components.Layout
@using Microsoft.AspNetCore.Components.Authorization
@using QDeskPro.Data
@using QDeskPro.Domain.Entities
@using QDeskPro.Features.Timeline.Services
@using Microsoft.EntityFrameworkCore
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider
@inject AppDbContext DbContext
@inject TimelineService TimelineService

@*
    MainLayout - Primary layout for authenticated pages

    ARCHITECTURE (Pure Blazor Server):
    - This layout is rendered statically, but becomes interactive via Routes @rendermode in App.razor
    - Setting @rendermode on layouts directly causes "Cannot pass Body parameter" error
    - MudThemeProvider is in Routes.razor with InteractiveServer
    - MudPopoverProvider/DialogProvider/SnackbarProvider are in MudProviders.razor
    - Account pages use AccountLayout which remains SSR for proper auth (ExcludeFromInteractiveRouting)
*@

<MudLayout>
    @* Modern App Bar with Gradient Effect *@
    <MudAppBar Elevation="0" Fixed="true" Class="qdp-appbar">
        @if (_isAuthenticated)
        {
            <MudIconButton Icon="@Icons.Material.Rounded.Menu"
                           Color="Color.Inherit"
                           Edge="Edge.Start"
                           OnClick="@ToggleDrawer"
                           Class="mr-2" />
        }

        @* App Logo and Brand *@
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mr-4">
            <div class="qdp-appbar-logo-icon">
                <MudIcon Icon="@Icons.Material.Rounded.Terrain" Size="Size.Medium" Color="Color.Surface" />
            </div>
            <div class="d-none d-sm-block">
                <MudText Typo="Typo.h6" Class="qdp-brand-text" Style="color: white; margin: 0;">QDeskPro</MudText>
                <MudText Class="qdp-brand-subtitle" Style="color: rgba(255,255,255,0.85); margin: 0;">Quarry Management</MudText>
            </div>
        </MudStack>

        <MudSpacer />

        @* Notes Timeline Toggle - Manager/Admin only *@
        <AuthorizeView Roles="Manager,Administrator">
            <Authorized>
                <MudTooltip Text="Notes Timeline" Placement="Placement.Bottom">
                    <MudBadge Content="@_pendingNotesCount"
                              Color="Color.Error"
                              Overlap="true"
                              Visible="@(_pendingNotesCount > 0)"
                              Class="mr-2">
                        <MudIconButton Icon="@Icons.Material.Filled.EventNote"
                                      Color="Color.Inherit"
                                      OnClick="ToggleNotesPanel" />
                    </MudBadge>
                </MudTooltip>
            </Authorized>
        </AuthorizeView>

        @* User Menu *@
        <AuthorizeView>
            <Authorized>
                <MudMenu AnchorOrigin="Origin.BottomRight"
                         TransformOrigin="Origin.TopRight"
                         PopoverClass="qdp-user-menu-popover">
                    <ActivatorContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="ml-2 cursor-pointer pa-2 rounded-lg qdp-user-menu-trigger">
                            <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="qdp-user-avatar">
                                <MudIcon Icon="@Icons.Material.Rounded.Person" />
                            </MudAvatar>
                            <div class="d-none d-sm-block ml-2">
                                <MudText Typo="Typo.body2" Class="font-weight-semibold" Style="line-height: 1.2;">@context.User.Identity?.Name</MudText>
                                <MudText Typo="Typo.caption" Class="qdp-user-role">@GetUserRole(context)</MudText>
                            </div>
                            <MudIcon Icon="@Icons.Material.Rounded.KeyboardArrowDown" Size="Size.Small" Class="d-none d-sm-block" />
                        </MudStack>
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem Icon="@Icons.Material.Rounded.Person" IconColor="Color.Primary"
                                     OnClick="@NavigateToProfile">
                            <MudText Typo="Typo.body2">My Profile</MudText>
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Rounded.Settings" IconColor="Color.Default">
                            <MudText Typo="Typo.body2">Settings</MudText>
                        </MudMenuItem>
                        <MudDivider Class="my-2" />
                        <MudMenuItem Icon="@Icons.Material.Rounded.Logout"
                                     IconColor="Color.Error"
                                     OnClick="@PerformLogout">
                            <MudText Typo="Typo.body2" Color="Color.Error">Sign Out</MudText>
                        </MudMenuItem>
                    </ChildContent>
                </MudMenu>
            </Authorized>
            <NotAuthorized>
                <MudButton Variant="Variant.Text"
                           Color="Color.Inherit"
                           StartIcon="@Icons.Material.Rounded.Login"
                           Class="qdp-login-btn"
                           OnClick="NavigateToLogin">
                    Sign In
                </MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>

    @* Modern Sidebar Drawer - Only show for authenticated users *@
    @if (_isAuthenticated)
    {
        <MudDrawer @bind-Open="_drawerOpen"
                   ClipMode="DrawerClipMode.Always"
                   Elevation="0"
                   Width="280px"
                   Class="qdp-drawer"
                   Variant="@DrawerVariant.Persistent"
                   Breakpoint="Breakpoint.Md"
                   DisableOverlay="true">

            @* Drawer Header *@
            <div class="qdp-drawer-header">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                    <MudAvatar Size="Size.Large" Class="qdp-drawer-logo">
                        <MudIcon Icon="@Icons.Material.Rounded.Layers" Size="Size.Large" />
                    </MudAvatar>
                    <div>
                        <MudText Typo="Typo.h6" Class="font-weight-bold">@_quarryName</MudText>
                        <MudText Class="qdp-drawer-header-subtitle">@_quarrySubtitle</MudText>
                    </div>
                </MudStack>
            </div>

            @* Navigation Menu *@
            <div class="qdp-nav-menu">
                <NavMenu />
            </div>

            @* Drawer Footer *@
            <MudSpacer />
            <div class="qdp-drawer-footer">
                <MudDivider Class="mb-3" />
                <MudText Typo="Typo.caption" Class="text-center" Color="Color.Secondary">
                    v1.0.0 - Phase 1
                </MudText>
            </div>
        </MudDrawer>
    }

    @* Notes Timeline Panel (Right Side) - Manager/Admin only *@
    @* Using custom CSS panel instead of MudDrawer for proper click handling *@
    <AuthorizeView Roles="Manager,Administrator">
        <Authorized>
            @* Overlay backdrop - only visible when panel is open *@
            @if (_notesPanelOpen)
            {
                <div class="qdp-notes-overlay-backdrop" @onclick="CloseNotesPanel"></div>
            }

            @* Sliding panel - transforms based on open state *@
            <div class="qdp-notes-panel @(_notesPanelOpen ? "qdp-notes-panel--open" : "")">
                <div class="pa-4 qdp-notes-panel-content">
                    @* Header *@
                    <div class="d-flex justify-space-between align-center mb-3">
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.Timeline" Class="mr-2" Style="vertical-align: middle;" />
                            Notes Timeline
                        </MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                      Size="Size.Small"
                                      OnClick="@(() => _notesPanelOpen = false)" />
                    </div>

                    @* Quarry Filter *@
                    @if (_userQuarries.Count > 1)
                    {
                        <MudSelect T="string"
                                   Value="_selectedQuarryFilter"
                                   ValueChanged="OnQuarryFilterChanged"
                                   Label="Quarry"
                                   Variant="Variant.Outlined"
                                   Dense="true"
                                   Class="mb-3"
                                   AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem Value="@("All")">All Quarries</MudSelectItem>
                            @foreach (var quarry in _userQuarries)
                            {
                                <MudSelectItem Value="@quarry.Id">@quarry.QuarryName</MudSelectItem>
                            }
                        </MudSelect>
                    }

                    @* Type Filters *@
                    <MudChipSet T="string" SelectionMode="SelectionMode.SingleSelection"
                               SelectedValue="_notesFilter"
                               SelectedValueChanged="OnTypeFilterChanged"
                               Class="mb-3">
                        <MudChip Value="@("All")" Color="Color.Default" Variant="Variant.Outlined" Default="true">All</MudChip>
                        <MudChip Value="@("Note")" Color="Color.Primary" Variant="Variant.Outlined">Notes</MudChip>
                        <MudChip Value="@("Reminder")" Color="Color.Warning" Variant="Variant.Outlined">Reminders</MudChip>
                        <MudChip Value="@("Task")" Color="Color.Success" Variant="Variant.Outlined">Tasks</MudChip>
                    </MudChipSet>

                    @* Timeline Content *@
                    @if (_loadingNotes)
                    {
                        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
                    }
                    else
                    {
                        <div class="qdp-timeline-scroll" style="max-height: calc(100vh - 250px); overflow-y: auto;">
                            @foreach (var dateGroup in _timelineNotes.GroupBy(n => n.DateCreated.Date).OrderByDescending(g => g.Key))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2 mt-3">
                                    @FormatDateHeader(dateGroup.Key)
                                </MudText>

                                @foreach (var note in dateGroup.OrderByDescending(n => n.DateCreated))
                                {
                                    <MudCard Elevation="0" Class="mb-2 qdp-timeline-card" Outlined="true">
                                        <MudCardContent Class="pa-3">
                                            <div class="d-flex align-start gap-2">
                                                <MudIcon Icon="@GetNoteIcon(note.CommentType)"
                                                        Color="@GetNoteColor(note.CommentType)"
                                                        Size="Size.Small" />
                                                <div class="flex-grow-1">
                                                    @if (!string.IsNullOrEmpty(note.Title))
                                                    {
                                                        <MudText Typo="Typo.body2" Class="font-weight-medium">
                                                            @note.Title
                                                        </MudText>
                                                    }
                                                    <MudText Typo="Typo.body2">@note.Content</MudText>

                                                    @if (!string.IsNullOrEmpty(note.LinkedEntityReference))
                                                    {
                                                        <MudChip T="string" Size="Size.Small"
                                                                Color="Color.Info"
                                                                Variant="Variant.Text"
                                                                Class="mt-1 pa-0">
                                                            @note.LinkedEntityType: @note.LinkedEntityReference
                                                        </MudChip>
                                                    }

                                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                                                        @note.AuthorName &bull; @FormatTimeAgo(note.DateCreated)
                                                        @if (_userQuarries.Count > 1 && _selectedQuarryFilter == "All")
                                                        {
                                                            var quarryName = _userQuarries.FirstOrDefault(q => q.Id == note.QuarryId)?.QuarryName;
                                                            if (!string.IsNullOrEmpty(quarryName))
                                                            {
                                                                <text> &bull; @quarryName</text>
                                                            }
                                                        }
                                                    </MudText>
                                                </div>

                                                @if (note.CommentType == "Task" && !note.IsCompleted)
                                                {
                                                    <MudIconButton Icon="@Icons.Material.Filled.CheckCircleOutline"
                                                                  Size="Size.Small"
                                                                  Color="Color.Success"
                                                                  OnClick="@(() => MarkTaskCompleteAsync(note))" />
                                                }
                                            </div>
                                        </MudCardContent>
                                    </MudCard>
                                }
                            }

                            @if (!_timelineNotes.Any())
                            {
                                <div class="text-center pa-4">
                                    <MudIcon Icon="@Icons.Material.Filled.Notes"
                                            Size="Size.Large"
                                            Color="Color.Secondary" />
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                                        No notes yet. Add notes from reports and dashboards.
                                    </MudText>
                                </div>
                            }
                        </div>
                    }

                    @* View Full Timeline Link *@
                    <div class="mt-3 text-center">
                        <MudButton Variant="Variant.Text"
                                  Color="Color.Primary"
                                  Href="/manager/timeline"
                                  OnClick="@(() => _notesPanelOpen = false)">
                            View Full Timeline
                        </MudButton>
                    </div>
                </div>
            </div>
        </Authorized>
    </AuthorizeView>

    @* Main Content Area *@
    <MudMainContent Class="@GetMainContentClass()">
        <div class="qdp-content-wrapper">
            @Body
        </div>
    </MudMainContent>

    @* Bottom Navigation for Clerks (Mobile Only) *@
    <AuthorizeView Roles="Clerk">
        <Authorized>
            <BottomNavigation />
        </Authorized>
    </AuthorizeView>
</MudLayout>

@* Error UI *@
<div id="blazor-error-ui" data-nosnippet>
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="rounded-lg">
        An unhandled error has occurred.
        <a href="." class="mud-alert-link">Reload</a>
        <span class="dismiss">X</span>
    </MudAlert>
</div>

@code {
    private bool _drawerOpen = true;
    private string? currentUrl;
    private string _quarryName = "Loading...";
    private string _quarrySubtitle = "";
    private bool _isAuthenticated = false;
    private bool _isMobile = false;

    // Notes Timeline Panel fields
    private bool _notesPanelOpen = false;
    private bool _loadingNotes = false;
    private string _notesFilter = "All";
    private string _selectedQuarryFilter = "All";
    private int _pendingNotesCount = 0;
    private List<QuarryComment> _timelineNotes = new();
    private List<Quarry> _userQuarries = new();

    // Receive dark mode state from Routes.razor cascading value
    [CascadingParameter(Name = "IsDarkMode")]
    private bool IsDarkMode { get; set; }

    protected override async Task OnInitializedAsync()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;

        // Check authentication status
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _isAuthenticated = authState.User.Identity?.IsAuthenticated == true;

        await LoadQuarryInfoAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Check screen width and collapse drawer on mobile
            try
            {
                var screenWidth = await JS.InvokeAsync<int>("eval", "window.innerWidth");
                _isMobile = screenWidth < 960; // MudBlazor Md breakpoint

                if (_isMobile)
                {
                    _drawerOpen = false;
                    StateHasChanged();
                }
            }
            catch
            {
                // Fallback: keep drawer open if JS fails
            }
        }
    }

    private async Task LoadQuarryInfoAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                var userRole = user.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;

                if (string.IsNullOrEmpty(userId))
                {
                    _quarryName = "QDeskPro";
                    _quarrySubtitle = "Quarry Management";
                    return;
                }

                if (userRole == "Administrator")
                {
                    _quarryName = "System Admin";
                    _quarrySubtitle = "All Quarries";
                }
                else if (userRole == "Manager")
                {
                    // Get manager's first quarry
                    var firstQuarry = await DbContext.Quarries
                        .Where(q => q.ManagerId == userId)
                        .OrderBy(q => q.DateCreated)
                        .FirstOrDefaultAsync();

                    if (firstQuarry != null)
                    {
                        _quarryName = firstQuarry.QuarryName;
                        _quarrySubtitle = firstQuarry.Location ?? "Manager View";
                    }
                    else
                    {
                        _quarryName = "Manager";
                        _quarrySubtitle = "No Quarries Assigned";
                    }
                }
                else if (userRole == "Clerk")
                {
                    // Get clerk's assigned quarry
                    var userEntity = await DbContext.Users.FindAsync(userId);

                    if (userEntity != null && !string.IsNullOrEmpty(userEntity.QuarryId))
                    {
                        var quarry = await DbContext.Quarries.FindAsync(userEntity.QuarryId);

                        if (quarry != null)
                        {
                            _quarryName = quarry.QuarryName;
                            _quarrySubtitle = quarry.Location ?? "Clerk View";
                        }
                        else
                        {
                            _quarryName = "Clerk";
                            _quarrySubtitle = "No Quarry Assigned";
                        }
                    }
                    else
                    {
                        _quarryName = "Clerk";
                        _quarrySubtitle = "No Quarry Assigned";
                    }
                }
                else
                {
                    _quarryName = "QDeskPro";
                    _quarrySubtitle = "Quarry Management";
                }
            }
            else
            {
                _quarryName = "QDeskPro";
                _quarrySubtitle = "Quarry Management";
            }
        }
        catch (Exception ex)
        {
            _quarryName = "QDeskPro";
            _quarrySubtitle = "Quarry Management";
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    // Notes Timeline Panel methods
    private async Task ToggleNotesPanel()
    {
        _notesPanelOpen = !_notesPanelOpen;
        if (_notesPanelOpen)
        {
            await LoadUserQuarries();
            await LoadTimelineNotes();
        }
    }

    private void CloseNotesPanel()
    {
        _notesPanelOpen = false;
    }

    private async Task LoadUserQuarries()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var userRole = user.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                _userQuarries = new List<Quarry>();
                return;
            }

            if (userRole == "Administrator")
            {
                _userQuarries = await DbContext.Quarries
                    .Where(q => q.IsActive)
                    .OrderBy(q => q.QuarryName)
                    .ToListAsync();
            }
            else if (userRole == "Manager")
            {
                _userQuarries = await DbContext.Quarries
                    .Where(q => q.ManagerId == userId && q.IsActive)
                    .OrderBy(q => q.QuarryName)
                    .ToListAsync();
            }
            else
            {
                _userQuarries = new List<Quarry>();
            }
        }
        catch
        {
            _userQuarries = new List<Quarry>();
        }
    }

    private async Task OnTypeFilterChanged(string value)
    {
        _notesFilter = value ?? "All";
        await LoadTimelineNotes();
    }

    private async Task OnQuarryFilterChanged(string value)
    {
        _selectedQuarryFilter = value ?? "All";
        await LoadTimelineNotes();
    }

    private async Task LoadTimelineNotes()
    {
        _loadingNotes = true;
        StateHasChanged();

        try
        {
            List<string> quarryIds;

            // Apply quarry filter
            if (_selectedQuarryFilter == "All")
            {
                quarryIds = _userQuarries.Select(q => q.Id).ToList();
            }
            else
            {
                quarryIds = new List<string> { _selectedQuarryFilter };
            }

            if (quarryIds.Any())
            {
                // Apply type filter if not "All"
                var commentType = _notesFilter == "All" ? null : _notesFilter;
                _timelineNotes = await TimelineService.GetRecentNotesAsync(quarryIds, commentType, limit: 50);
                _pendingNotesCount = await TimelineService.GetPendingTasksCountAsync(quarryIds);
            }
            else
            {
                _timelineNotes = new List<QuarryComment>();
                _pendingNotesCount = 0;
            }
        }
        catch (Exception ex)
        {
            _timelineNotes = new List<QuarryComment>();
            _pendingNotesCount = 0;
        }
        finally
        {
            _loadingNotes = false;
            StateHasChanged();
        }
    }

    private async Task<List<string>> GetUserQuarryIds()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        var userRole = user.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;

        if (string.IsNullOrEmpty(userId)) return new List<string>();

        if (userRole == "Administrator")
        {
            // Admin sees all quarries
            return await DbContext.Quarries
                .Where(q => q.IsActive)
                .Select(q => q.Id)
                .ToListAsync();
        }
        else if (userRole == "Manager")
        {
            // Manager sees quarries they own
            return await DbContext.Quarries
                .Where(q => q.ManagerId == userId && q.IsActive)
                .Select(q => q.Id)
                .ToListAsync();
        }

        return new List<string>();
    }

    private async Task MarkTaskCompleteAsync(QuarryComment note)
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";

        var result = await TimelineService.MarkAsCompletedAsync(note.Id, userId);
        if (result.Success)
        {
            await LoadTimelineNotes();
        }
    }

    private string FormatDateHeader(DateTime date)
    {
        if (date.Date == DateTime.Today) return "Today";
        if (date.Date == DateTime.Today.AddDays(-1)) return "Yesterday";
        if (date.Date > DateTime.Today.AddDays(-7)) return date.ToString("dddd");
        return date.ToString("MMMM d, yyyy");
    }

    private string FormatTimeAgo(DateTime dateTime)
    {
        var diff = DateTime.UtcNow - dateTime;

        if (diff.TotalMinutes < 1) return "Just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d ago";
        return dateTime.ToString("MMM d");
    }

    private string GetNoteIcon(string? commentType) => commentType switch
    {
        "Note" => Icons.Material.Filled.Note,
        "Reminder" => Icons.Material.Filled.Alarm,
        "Task" => Icons.Material.Filled.CheckCircle,
        _ => Icons.Material.Filled.Notes
    };

    private Color GetNoteColor(string? commentType) => commentType switch
    {
        "Note" => Color.Primary,
        "Reminder" => Color.Warning,
        "Task" => Color.Success,
        _ => Color.Default
    };

    private string GetMainContentClass()
    {
        var baseClass = "qdp-main-content";
        if (_isAuthenticated && _drawerOpen)
        {
            return $"{baseClass} drawer-open";
        }
        return baseClass;
    }

    // Theme toggle is now handled in Routes.razor via ThemeService cascading value
    [CascadingParameter(Name = "ThemeService")]
    private Routes? ThemeService { get; set; }

    private void HandleThemeChanged(bool isDark)
    {
        // Delegate theme change to Routes.razor which owns the theme state
        ThemeService?.ToggleTheme();
    }

    private string GetUserRole(AuthenticationState context)
    {
        if (context.User.IsInRole("Administrator"))
            return "Administrator";
        if (context.User.IsInRole("Manager"))
            return "Manager";
        if (context.User.IsInRole("Clerk"))
            return "Clerk";
        return "User";
    }

    private async Task PerformLogout()
    {
        // Use JavaScript window.location.replace to force a hard navigation
        // This ensures a complete browser reload, not a Blazor SPA navigation
        await JS.InvokeVoidAsync("eval", "window.location.replace('/Account/Logout')");
    }

    private void NavigateToProfile()
    {
        // Navigate to the static SSR account management page
        NavigationManager.NavigateTo("Account/Manage", forceLoad: true);
    }

    private void NavigateToLogin()
    {
        // Navigate to the static SSR login page with force reload
        NavigationManager.NavigateTo("/Account/Login", forceLoad: true);
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}

<style>
    /* AppBar Gradient Enhancement */
    .qdp-appbar {
        background: linear-gradient(135deg, #1565C0 0%, #0D47A1 50%, #1A237E 100%) !important;
        box-shadow: 0 4px 20px rgba(21, 101, 192, 0.3) !important;
    }

    .qdp-brand-text {
        font-weight: 800 !important;
        letter-spacing: -0.02em;
        line-height: 1.1;
    }

    .qdp-brand-subtitle {
        opacity: 0.85;
        font-size: 0.65rem !important;
        letter-spacing: 0.08em;
        text-transform: uppercase;
    }

    .qdp-appbar-logo-icon {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* User Menu */
    .qdp-user-menu-trigger {
        transition: background-color 0.2s ease;
    }

    .qdp-user-menu-trigger:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .qdp-user-avatar {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .qdp-user-role {
        opacity: 0.8;
        font-size: 0.7rem !important;
    }

    .qdp-user-menu-popover {
        border-radius: 16px !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15) !important;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* Login Link */
    .qdp-login-link {
        text-decoration: none !important;
        color: inherit !important;
    }

    /* Login Button */
    .qdp-login-btn {
        border-radius: 12px !important;
        padding: 8px 20px !important;
        font-weight: 600 !important;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        transition: all 0.2s ease;
    }

    .qdp-login-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    /* Drawer Styling */
    .qdp-drawer {
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%) !important;
        border-right: 1px solid #e0e6ed !important;
        box-shadow: none !important;
        position: fixed !important;
        height: 100vh !important;
        z-index: 1200 !important;
    }

    /* Drawer on desktop - persistent behavior */
    @@media (min-width: 960px) {
        .qdp-drawer.mud-drawer--open {
            position: fixed !important;
        }
    }

    /* Fix drawer content overflow to prevent header cutoff */
    .qdp-drawer .mud-drawer-content {
        overflow-x: hidden !important;
        overflow-y: auto !important;
        display: flex !important;
        flex-direction: column !important;
        margin-top: 0 !important;
        padding-top: 0 !important;
    }

    /* Fix MudDrawer clipped mode positioning */
    .qdp-drawer.mud-drawer--clipped-always {
        margin-top: 0 !important;
    }

    /* Ensure first child (header) is not clipped */
    .qdp-drawer .mud-drawer-content > :first-child {
        flex-shrink: 0;
        margin-top: 0 !important;
    }

    .qdp-drawer-header {
        background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
        padding: 24px 20px;
        color: white;
        position: relative;
        overflow: hidden;
        flex-shrink: 0; /* Prevent header from shrinking */
        margin-top: 0 !important;
        min-height: 90px; /* Ensure minimum height for header */
        z-index: 1; /* Ensure header is above any overlapping elements */
        box-sizing: border-box;
    }

    .qdp-drawer-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -30%;
        width: 100%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        pointer-events: none;
    }

    .qdp-drawer-logo {
        background: rgba(255, 255, 255, 0.2) !important;
        backdrop-filter: blur(10px);
    }

    .qdp-drawer-header-subtitle {
        color: rgba(255, 255, 255, 0.75) !important;
        font-size: 0.7rem !important;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-top: 2px;
    }

    .qdp-drawer-footer {
        padding: 16px 20px;
    }

    /* Main Content */
    .qdp-main-content {
        background: #f5f7fa !important;
        min-height: calc(100vh - 64px);
        transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin-left: 0;
    }

    /* Main content with drawer open on desktop */
    @@media (min-width: 960px) {
        .qdp-main-content.drawer-open {
            margin-left: 280px !important;
        }
    }

    /* MudBlazor Layout Integration - Remove all gaps */
    .mud-layout {
        gap: 0 !important;
    }

    /* Content Wrapper - provides consistent padding inside */
    .qdp-content-wrapper {
        padding: 24px;
        animation: fadeInUp 0.4s ease-out;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow: visible !important; /* Allow picker popovers to extend beyond */
    }

    @@media (min-width: 960px) {
        .qdp-content-wrapper {
            padding: 32px;
        }
    }

    /* Remove any drawer shadow/gap that might appear */
    .mud-drawer {
        box-shadow: none !important;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(12px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Error UI styling */
    #blazor-error-ui {
        display: none;
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
    }

    #blazor-error-ui .mud-alert {
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    /* Notes Timeline Overlay Backdrop */
    .qdp-notes-overlay-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1299;
        cursor: pointer;
    }

    /* Notes Timeline Sliding Panel */
    .qdp-notes-panel {
        position: fixed;
        top: 0;
        right: 0;
        width: 400px;
        height: 100vh;
        background-color: #ffffff;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
        z-index: 1300;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow-y: auto;
    }

    /* Panel open state */
    .qdp-notes-panel--open {
        transform: translateX(0);
    }

    /* Responsive width for smaller screens */
    @@media (max-width: 480px) {
        .qdp-notes-panel {
            width: 100%;
        }
    }

    /* Solid panel content */
    .qdp-notes-panel-content {
        background-color: #ffffff;
        min-height: 100%;
        position: relative;
    }

    /* Dark mode support */
    .mud-theme-dark .qdp-notes-panel,
    .mud-theme-dark .qdp-notes-panel-content {
        background-color: #1e1e1e;
    }

    .mud-theme-dark .qdp-notes-overlay-backdrop {
        background-color: rgba(0, 0, 0, 0.7);
    }

    .qdp-timeline-card {
        border-radius: 8px;
        transition: box-shadow 0.2s ease, transform 0.2s ease;
        background-color: #ffffff;
    }

    .mud-theme-dark .qdp-timeline-card {
        background-color: #2d2d2d;
    }

    .qdp-timeline-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }

    .qdp-timeline-scroll {
        scrollbar-width: thin;
        scrollbar-color: rgba(0,0,0,0.2) transparent;
    }

    .qdp-timeline-scroll::-webkit-scrollbar {
        width: 6px;
    }

    .qdp-timeline-scroll::-webkit-scrollbar-track {
        background: transparent;
    }

    .qdp-timeline-scroll::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.2);
        border-radius: 3px;
    }

    .qdp-timeline-scroll::-webkit-scrollbar-thumb:hover {
        background-color: rgba(0,0,0,0.3);
    }
</style>
