@page "/Account/Register"
@rendermode InteractiveServer
@layout QDeskPro.Components.Account.Shared.AccountLayout

@using MudBlazor
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Authorization
@using QDeskPro.Shared.Services

@inject HttpClient Http
@inject ILogger<Register> Logger
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject LocalStorageService LocalStorage

<PageTitle>Create Account - QDeskPro</PageTitle>

<div class="register-page">
    <div class="register-background">
        <div class="register-pattern"></div>
    </div>

    <div class="register-container">
        @* Side Branding *@
        <div class="register-branding d-none d-md-flex">
            <div class="branding-content">
                <MudIcon Icon="@Icons.Material.Rounded.Terrain" Size="Size.Large" Class="branding-icon" />
                <MudText Typo="Typo.h3" Class="branding-title">QDeskPro</MudText>
                <MudText Typo="Typo.h6" Class="branding-subtitle">Join Us Today</MudText>
                <MudText Typo="Typo.body1" Class="branding-description">
                    Create your account and start managing your quarry operations
                    with powerful tools designed for efficiency.
                </MudText>

                <MudStack Spacing="2" Class="branding-features">
                    <div class="branding-feature">
                        <MudIcon Icon="@Icons.Material.Rounded.CheckCircle" Size="Size.Small" />
                        <MudText Typo="Typo.body2">Free to get started</MudText>
                    </div>
                    <div class="branding-feature">
                        <MudIcon Icon="@Icons.Material.Rounded.CheckCircle" Size="Size.Small" />
                        <MudText Typo="Typo.body2">Secure data storage</MudText>
                    </div>
                    <div class="branding-feature">
                        <MudIcon Icon="@Icons.Material.Rounded.CheckCircle" Size="Size.Small" />
                        <MudText Typo="Typo.body2">24/7 support available</MudText>
                    </div>
                </MudStack>
            </div>
        </div>

        <MudPaper Class="register-card" Elevation="0">
            @* Logo Section *@
            <div class="register-header">
                <div class="register-logo">
                    <MudIcon Icon="@Icons.Material.Rounded.PersonAdd" Size="Size.Large" />
                </div>
                <MudText Typo="Typo.h4" Class="register-title">Create Account</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Fill in your details to get started</MudText>
            </div>

            @* Register Form *@
            <div class="register-form-container">
                <StatusMessage Message="@errorMessage" />

                <EditForm Model="Input" OnValidSubmit="RegisterUser">
                    <DataAnnotationsValidator />

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Class="mb-4" Variant="Variant.Outlined" Dense="true">
                            @errorMessage
                        </MudAlert>
                    }

                    <MudStack Spacing="3">
                        <MudTextField @bind-Value="Input.FullName"
                                      Label="Full Name"
                                      Variant="Variant.Outlined"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Rounded.Person"
                                      AdornmentColor="Color.Primary"
                                      autocomplete="name"
                                      Required="true"
                                      RequiredError="Full name is required"
                                      Class="register-input" />

                        <MudTextField @bind-Value="Input.Email"
                                      Label="Email Address"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Email"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Rounded.Email"
                                      AdornmentColor="Color.Primary"
                                      autocomplete="username"
                                      Required="true"
                                      RequiredError="Email is required"
                                      Class="register-input" />

                        <MudTextField @bind-Value="Input.Password"
                                      Label="Password"
                                      Variant="Variant.Outlined"
                                      InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@(_showPassword ? Icons.Material.Rounded.VisibilityOff : Icons.Material.Rounded.Visibility)"
                                      AdornmentColor="Color.Default"
                                      OnAdornmentClick="() => _showPassword = !_showPassword"
                                      autocomplete="new-password"
                                      Required="true"
                                      RequiredError="Password is required"
                                      HelperText="At least 6 characters"
                                      Class="register-input" />

                        <MudTextField @bind-Value="Input.ConfirmPassword"
                                      Label="Confirm Password"
                                      Variant="Variant.Outlined"
                                      InputType="@(_showConfirmPassword ? InputType.Text : InputType.Password)"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@(_showConfirmPassword ? Icons.Material.Rounded.VisibilityOff : Icons.Material.Rounded.Visibility)"
                                      AdornmentColor="Color.Default"
                                      OnAdornmentClick="() => _showConfirmPassword = !_showConfirmPassword"
                                      autocomplete="new-password"
                                      Required="true"
                                      RequiredError="Please confirm your password"
                                      Class="register-input" />

                        <MudButton ButtonType="ButtonType.Submit"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Size="Size.Large"
                                   FullWidth="true"
                                   Class="register-button"
                                   Disabled="@isLoading"
                                   StartIcon="@(isLoading ? Icons.Material.Rounded.HourglassEmpty : Icons.Material.Rounded.PersonAdd)">
                            @(isLoading ? "Creating account..." : "Create Account")
                        </MudButton>
                    </MudStack>
                </EditForm>

                @* Divider *@
                <div class="register-divider">
                    <MudDivider />
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="divider-text">or register with</MudText>
                    <MudDivider />
                </div>

                @* External Login *@
                <div class="external-login-section">
                    <ExternalLoginPicker />
                </div>
            </div>

            @* Footer *@
            <div class="register-footer">
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Already have an account?
                    <MudLink Href="Account/Login" Color="Color.Primary" Typo="Typo.body2" Class="font-weight-semibold">
                        Sign in instead
                    </MudLink>
                </MudText>
            </div>
        </MudPaper>
    </div>
</div>

<style>
    .register-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        padding: 20px;
    }

    .register-background {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #0D47A1 0%, #1A237E 50%, #311B92 100%);
        z-index: -1;
    }

    .register-pattern {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image:
            radial-gradient(circle at 75% 25%, rgba(255,255,255,0.1) 0%, transparent 50%),
            radial-gradient(circle at 25% 75%, rgba(255,255,255,0.05) 0%, transparent 50%);
        animation: patternFloat 20s ease-in-out infinite;
    }

    @@keyframes patternFloat {
        0%, 100% { transform: translateY(0) scale(1); }
        50% { transform: translateY(-20px) scale(1.02); }
    }

    .register-container {
        display: flex;
        max-width: 1000px;
        width: 100%;
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
    }

    .register-card {
        background: rgba(255, 255, 255, 0.98) !important;
        padding: 48px;
        flex: 1;
        min-width: 400px;
        backdrop-filter: blur(20px);
    }

    .register-header {
        text-align: center;
        margin-bottom: 32px;
    }

    .register-logo {
        width: 72px;
        height: 72px;
        border-radius: 20px;
        background: linear-gradient(135deg, #0D47A1 0%, #1A237E 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        color: white;
        box-shadow: 0 8px 32px rgba(13, 71, 161, 0.3);
    }

    .register-title {
        font-weight: 700 !important;
        color: #1a1a2e;
        margin-bottom: 8px;
    }

    .register-form-container {
        margin-bottom: 24px;
    }

    .register-input .mud-input-outlined-border {
        border-radius: 12px !important;
    }

    .register-button {
        border-radius: 12px !important;
        padding: 12px 24px !important;
        font-weight: 600 !important;
        text-transform: none !important;
        letter-spacing: 0.02em;
        box-shadow: 0 4px 16px rgba(13, 71, 161, 0.3) !important;
        margin-top: 8px;
    }

    .register-button:hover {
        box-shadow: 0 6px 24px rgba(13, 71, 161, 0.4) !important;
        transform: translateY(-1px);
    }

    .register-divider {
        display: flex;
        align-items: center;
        gap: 16px;
        margin: 24px 0;
    }

    .register-divider .mud-divider {
        flex: 1;
    }

    .divider-text {
        white-space: nowrap;
    }

    .external-login-section {
        margin-top: 16px;
    }

    .register-footer {
        text-align: center;
        padding-top: 24px;
        border-top: 1px solid #e0e6ed;
    }

    /* Branding Section */
    .register-branding {
        flex: 1;
        background: linear-gradient(135deg, rgba(26, 35, 126, 0.95) 0%, rgba(49, 27, 146, 0.95) 100%);
        padding: 48px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .register-branding::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -30%;
        width: 100%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        pointer-events: none;
    }

    .branding-content {
        position: relative;
        z-index: 1;
    }

    .branding-icon {
        font-size: 3rem !important;
        margin-bottom: 16px;
        opacity: 0.9;
    }

    .branding-title {
        font-weight: 800 !important;
        margin-bottom: 8px;
        letter-spacing: -0.02em;
    }

    .branding-subtitle {
        opacity: 0.85;
        font-weight: 500 !important;
        margin-bottom: 24px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.75rem !important;
    }

    .branding-description {
        opacity: 0.9;
        line-height: 1.7;
        margin-bottom: 32px;
    }

    .branding-features {
        margin-top: 24px;
    }

    .branding-feature {
        display: flex;
        align-items: center;
        gap: 12px;
        opacity: 0.9;
    }

    .branding-feature .mud-icon-root {
        color: #4CAF50;
    }

    /* Responsive */
    @@media (max-width: 960px) {
        .register-card {
            min-width: unset;
            padding: 32px 24px;
        }

        .register-container {
            border-radius: 20px;
        }
    }

    @@media (max-width: 600px) {
        .register-page {
            padding: 12px;
        }

        .register-card {
            padding: 24px 20px;
        }

        .register-logo {
            width: 60px;
            height: 60px;
        }
    }
</style>

@code {
    private string? errorMessage;
    private bool isLoading = false;
    private bool _showPassword = false;
    private bool _showConfirmPassword = false;

    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    private async Task RegisterUser()
    {
        errorMessage = null;

        // Validate input
        if (string.IsNullOrWhiteSpace(Input.FullName))
        {
            errorMessage = "Full name is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Input.Email))
        {
            errorMessage = "Email is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Input.Password))
        {
            errorMessage = "Password is required.";
            return;
        }

        if (Input.Password != Input.ConfirmPassword)
        {
            errorMessage = "Passwords do not match.";
            return;
        }

        isLoading = true;
        StateHasChanged();

        try
        {
            var registerRequest = new
            {
                Email = Input.Email,
                Password = Input.Password,
                FullName = Input.FullName
            };

            var response = await Http.PostAsJsonAsync("/api/jwt-auth/register", registerRequest);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<RegisterResponse>();

                if (result != null && !string.IsNullOrEmpty(result.Token))
                {
                    // Store token in localStorage
                    await LocalStorage.SetItemAsync("authToken", result.Token);

                    // Store user info
                    await LocalStorage.SetItemAsync("userEmail", result.Email);
                    await LocalStorage.SetItemAsync("userFullName", result.FullName);
                    await LocalStorage.SetItemAsync("userRole", result.Role);

                    if (!string.IsNullOrEmpty(result.QuarryId))
                    {
                        await LocalStorage.SetItemAsync("userQuarryId", result.QuarryId);
                    }

                    // Update authentication state
                    if (AuthStateProvider is CustomAuthenticationStateProvider customAuthProvider)
                    {
                        await customAuthProvider.MarkUserAsAuthenticated(result.Token);
                    }

                    Logger.LogInformation("User {Email} registered successfully with JWT", Input.Email);

                    // Redirect to return URL or home
                    var redirectUrl = string.IsNullOrEmpty(ReturnUrl) ? "/" : ReturnUrl;
                    NavigationManager.NavigateTo(redirectUrl, forceLoad: true);
                }
                else
                {
                    errorMessage = "Error: Invalid response from server.";
                }
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                errorMessage = error?.Message ?? "Error: Registration failed. Please try again.";
                Logger.LogWarning("Registration failed for {Email}: {Error}", Input.Email, errorMessage);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Exception during registration for {Email}", Input.Email);
            errorMessage = "Error: An unexpected error occurred. Please try again.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "Full name is required")]
        public string FullName { get; set; } = "";

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Password is required")]
        [StringLength(100, ErrorMessage = "Password must be at least {2} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [Required(ErrorMessage = "Please confirm your password")]
        [DataType(DataType.Password)]
        [Compare("Password", ErrorMessage = "Passwords do not match.")]
        public string ConfirmPassword { get; set; } = "";
    }

    private record RegisterResponse
    {
        public string Token { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;
        public string? QuarryId { get; set; }
    }

    private record ErrorResponse
    {
        public string Message { get; set; } = string.Empty;
    }
}
