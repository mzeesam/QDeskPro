@page "/Account/ResetPassword"
@using MudBlazor
@using System.ComponentModel.DataAnnotations
@using System.Text
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using QDeskPro.Domain.Entities

@inject IdentityRedirectManager RedirectManager
@inject UserManager<ApplicationUser> UserManager

<PageTitle>Reset Password - QDeskPro</PageTitle>

<div class="reset-page">
    <div class="reset-background">
        <div class="reset-pattern"></div>
    </div>

    <MudContainer MaxWidth="MaxWidth.Small" Class="reset-container">
        <MudPaper Class="reset-card" Elevation="0">
            <div class="reset-header">
                <div class="reset-icon">
                    <MudIcon Icon="@Icons.Material.Rounded.Password" Size="Size.Large" />
                </div>
                <MudText Typo="Typo.h4" Class="reset-title">Create New Password</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Enter your email and choose a new secure password
                </MudText>
            </div>

            <div class="reset-form-container">
                <StatusMessage Message="@Message" />

                <EditForm Model="Input" FormName="reset-password" OnValidSubmit="OnValidSubmitAsync" method="post" Enhance>
                    <DataAnnotationsValidator />
                    <input type="hidden" name="Input.Code" value="@Input.Code" />

                    <MudStack Spacing="3">
                        <MudTextField @bind-Value="Input.Email"
                                      Label="Email Address"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Email"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Rounded.Email"
                                      AdornmentColor="Color.Primary"
                                      autocomplete="username"
                                      Required="true"
                                      RequiredError="Email is required"
                                      Class="reset-input" />

                        <MudTextField @bind-Value="Input.Password"
                                      Label="New Password"
                                      Variant="Variant.Outlined"
                                      InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@(_showPassword ? Icons.Material.Rounded.VisibilityOff : Icons.Material.Rounded.Visibility)"
                                      AdornmentColor="Color.Default"
                                      OnAdornmentClick="() => _showPassword = !_showPassword"
                                      autocomplete="new-password"
                                      Required="true"
                                      RequiredError="Password is required"
                                      HelperText="At least 6 characters"
                                      Class="reset-input" />

                        <MudTextField @bind-Value="Input.ConfirmPassword"
                                      Label="Confirm New Password"
                                      Variant="Variant.Outlined"
                                      InputType="@(_showConfirmPassword ? InputType.Text : InputType.Password)"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@(_showConfirmPassword ? Icons.Material.Rounded.VisibilityOff : Icons.Material.Rounded.Visibility)"
                                      AdornmentColor="Color.Default"
                                      OnAdornmentClick="() => _showConfirmPassword = !_showConfirmPassword"
                                      autocomplete="new-password"
                                      Required="true"
                                      RequiredError="Please confirm your password"
                                      Class="reset-input" />

                        <MudButton ButtonType="ButtonType.Submit"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Size="Size.Large"
                                   FullWidth="true"
                                   Class="reset-button"
                                   StartIcon="@Icons.Material.Rounded.LockReset">
                            Reset Password
                        </MudButton>
                    </MudStack>
                </EditForm>

                <MudPaper Class="reset-tips" Elevation="0">
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                        <strong>Password Tips:</strong>
                    </MudText>
                    <MudStack Spacing="1">
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Color="Color.Success" />
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Use at least 6 characters</MudText>
                        </MudStack>
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Color="Color.Success" />
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Mix letters and numbers</MudText>
                        </MudStack>
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Color="Color.Success" />
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Avoid common words</MudText>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </div>

            <div class="reset-footer">
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Remember your password?
                    <MudLink Href="Account/Login" Color="Color.Primary" Typo="Typo.body2" Class="font-weight-semibold">
                        Sign in instead
                    </MudLink>
                </MudText>
            </div>
        </MudPaper>
    </MudContainer>
</div>

<style>
    .reset-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        padding: 24px;
    }

    .reset-background {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #1565C0 0%, #0D47A1 50%, #1A237E 100%);
        z-index: -1;
    }

    .reset-pattern {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image:
            radial-gradient(circle at 70% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
            radial-gradient(circle at 30% 20%, rgba(255,255,255,0.05) 0%, transparent 50%);
        animation: patternFloat 20s ease-in-out infinite;
    }

    @@keyframes patternFloat {
        0%, 100% { transform: translateY(0) scale(1); }
        50% { transform: translateY(-20px) scale(1.02); }
    }

    .reset-container {
        display: flex;
        justify-content: center;
    }

    .reset-card {
        background: rgba(255, 255, 255, 0.98) !important;
        border-radius: 24px;
        padding: 48px;
        max-width: 450px;
        width: 100%;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(20px);
    }

    .reset-header {
        text-align: center;
        margin-bottom: 32px;
    }

    .reset-icon {
        width: 72px;
        height: 72px;
        border-radius: 20px;
        background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        color: white;
        box-shadow: 0 8px 32px rgba(21, 101, 192, 0.3);
    }

    .reset-title {
        font-weight: 700 !important;
        color: #1a1a2e;
        margin-bottom: 8px;
    }

    .reset-form-container {
        margin-bottom: 24px;
    }

    .reset-input .mud-input-outlined-border {
        border-radius: 12px !important;
    }

    .reset-button {
        border-radius: 12px !important;
        padding: 12px 24px !important;
        font-weight: 600 !important;
        text-transform: none !important;
        letter-spacing: 0.02em;
        box-shadow: 0 4px 16px rgba(21, 101, 192, 0.3) !important;
        margin-top: 8px;
    }

    .reset-button:hover {
        box-shadow: 0 6px 24px rgba(21, 101, 192, 0.4) !important;
        transform: translateY(-1px);
    }

    .reset-tips {
        background: #f5f7fa !important;
        border-radius: 12px;
        padding: 16px;
        margin-top: 24px;
    }

    .reset-footer {
        text-align: center;
        padding-top: 24px;
        border-top: 1px solid #e0e6ed;
    }

    @@media (max-width: 600px) {
        .reset-page {
            padding: 12px;
        }

        .reset-card {
            padding: 32px 24px;
        }

        .reset-icon {
            width: 60px;
            height: 60px;
        }
    }
</style>

@code {
    private IEnumerable<IdentityError>? identityErrors;
    private bool _showPassword = false;
    private bool _showConfirmPassword = false;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    [SupplyParameterFromQuery]
    private string? Code { get; set; }

    private string? Message => identityErrors is null ? null : $"Error: {string.Join(", ", identityErrors.Select(error => error.Description))}";

    protected override void OnInitialized()
    {
        Input ??= new();

        if (Code is null)
        {
            RedirectManager.RedirectTo("Account/InvalidPasswordReset");
            return;
        }

        Input.Code = Encoding.UTF8.GetString(WebEncoders.Base64UrlDecode(Code));
    }

    private async Task OnValidSubmitAsync()
    {
        var user = await UserManager.FindByEmailAsync(Input.Email);
        if (user is null)
        {
            // Don't reveal that the user does not exist
            RedirectManager.RedirectTo("Account/ResetPasswordConfirmation");
            return;
        }

        var result = await UserManager.ResetPasswordAsync(user, Input.Code, Input.Password);
        if (result.Succeeded)
        {
            RedirectManager.RedirectTo("Account/ResetPasswordConfirmation");
            return;
        }

        identityErrors = result.Errors;
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirm password")]
        [Compare("Password", ErrorMessage = "The password and confirmation password do not match.")]
        public string ConfirmPassword { get; set; } = "";

        [Required]
        public string Code { get; set; } = "";
    }
}
