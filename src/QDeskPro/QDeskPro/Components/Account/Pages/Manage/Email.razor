@page "/Account/Manage/Email"
@using MudBlazor
@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using QDeskPro.Domain.Entities

@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Manage Email - QDeskPro</PageTitle>

<div class="manage-email-page">
    <MudPaper Class="email-card" Elevation="0">
        <div class="email-card-header">
            <div class="email-icon">
                <MudIcon Icon="@Icons.Material.Rounded.Email" />
            </div>
            <MudText Typo="Typo.h5" Class="email-title">Email Settings</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Manage your email address and verification status
            </MudText>
        </div>

        <StatusMessage Message="@message" />

        <MudPaper Class="current-email-section" Elevation="0">
            <MudText Typo="Typo.body2" Class="font-weight-semibold mb-2">Current Email</MudText>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.body1">@email</MudText>
                @if (isEmailConfirmed)
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Rounded.Verified">
                        Verified
                    </MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Warning" Size="Size.Small" Icon="@Icons.Material.Rounded.Warning">
                        Not Verified
                    </MudChip>
                }
            </MudStack>

            @if (!isEmailConfirmed)
            {
                <form @onsubmit="OnSendEmailVerificationAsync" @formname="send-verification" method="post" class="mt-3">
                    <AntiforgeryToken />
                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="Variant.Outlined"
                               Color="Color.Warning"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Rounded.Send">
                        Send Verification Email
                    </MudButton>
                </form>
            }
        </MudPaper>

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.h6" Class="mb-3">Change Email</MudText>

        <EditForm Model="Input" FormName="change-email" OnValidSubmit="OnValidSubmitAsync" method="post" Enhance>
            <DataAnnotationsValidator />

            <MudStack Spacing="3">
                <MudTextField @bind-Value="Input.NewEmail"
                              Label="New Email Address"
                              Variant="Variant.Outlined"
                              InputType="InputType.Email"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Rounded.AlternateEmail"
                              AdornmentColor="Color.Primary"
                              autocomplete="email"
                              Required="true"
                              RequiredError="Email address is required"
                              HelperText="A confirmation link will be sent to this address"
                              Class="email-input" />

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Large"
                           FullWidth="true"
                           StartIcon="@Icons.Material.Rounded.SwapHoriz"
                           Class="email-button">
                    Change Email
                </MudButton>
            </MudStack>
        </EditForm>

        <MudPaper Class="email-info" Elevation="0">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                <MudIcon Icon="@Icons.Material.Rounded.Info" Size="Size.Small" Color="Color.Info" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Changing your email will require verification. You'll receive a confirmation link
                    at your new email address. Your email won't change until you click the link.
                </MudText>
            </MudStack>
        </MudPaper>
    </MudPaper>
</div>

<style>
    .manage-email-page {
        max-width: 500px;
    }

    .email-card {
        background: white !important;
        border-radius: 20px;
        padding: 32px;
        border: 1px solid #e0e6ed;
    }

    .email-card-header {
        text-align: center;
        margin-bottom: 28px;
    }

    .email-icon {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        color: white;
        box-shadow: 0 6px 24px rgba(21, 101, 192, 0.3);
    }

    .email-title {
        font-weight: 700 !important;
        color: #1a1a2e;
        margin-bottom: 8px;
    }

    .current-email-section {
        background: #f8fafc !important;
        border-radius: 12px;
        padding: 16px;
    }

    .email-input .mud-input-outlined-border {
        border-radius: 12px !important;
    }

    .email-button {
        border-radius: 12px !important;
        padding: 12px 24px !important;
        font-weight: 600 !important;
        text-transform: none !important;
        margin-top: 8px;
    }

    .email-info {
        background: #E3F2FD !important;
        border-radius: 12px;
        padding: 16px;
        margin-top: 24px;
    }
</style>

@code {
    private string? message;
    private ApplicationUser? user;
    private string? email;
    private bool isEmailConfirmed;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm(FormName = "change-email")]
    private InputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();

        user = await UserManager.GetUserAsync(HttpContext.User);
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        email = await UserManager.GetEmailAsync(user);
        isEmailConfirmed = await UserManager.IsEmailConfirmedAsync(user);

        Input.NewEmail ??= email;
    }

    private async Task OnValidSubmitAsync()
    {
        if (Input.NewEmail is null || Input.NewEmail == email)
        {
            message = "Your email is unchanged.";
            return;
        }

        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateChangeEmailTokenAsync(user, Input.NewEmail);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmailChange").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["email"] = Input.NewEmail, ["code"] = code });

        await EmailSender.SendConfirmationLinkAsync(user, Input.NewEmail, HtmlEncoder.Default.Encode(callbackUrl));

        message = "Confirmation link to change email sent. Please check your email.";
    }

    private async Task OnSendEmailVerificationAsync()
    {
        if (email is null)
        {
            return;
        }

        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code });

        await EmailSender.SendConfirmationLinkAsync(user, email, HtmlEncoder.Default.Encode(callbackUrl));

        message = "Verification email sent. Please check your email.";
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        [Display(Name = "New email")]
        public string? NewEmail { get; set; }
    }
}
