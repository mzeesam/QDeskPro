@page "/Account/Manage"
@using MudBlazor
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using QDeskPro.Domain.Entities

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Profile - QDeskPro</PageTitle>

<div class="manage-profile">
    <div class="profile-header">
        <MudAvatar Size="Size.Large" Color="Color.Primary" Class="profile-avatar">
            @(username?.Substring(0, 1).ToUpper() ?? "U")
        </MudAvatar>
        <div class="profile-header-info">
            <MudText Typo="Typo.h5" Class="profile-name">@username</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Manage your account settings</MudText>
        </div>
    </div>

    <StatusMessage />

    <MudPaper Class="profile-card" Elevation="0">
        <div class="profile-card-header">
            <MudIcon Icon="@Icons.Material.Rounded.Person" Color="Color.Primary" />
            <MudText Typo="Typo.h6">Personal Information</MudText>
        </div>

        <EditForm Model="Input" FormName="profile" OnValidSubmit="OnValidSubmitAsync" method="post" Enhance>
            <DataAnnotationsValidator />

            <MudStack Spacing="3">
                <MudTextField Value="@username"
                              Label="Username"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Rounded.AlternateEmail"
                              AdornmentColor="Color.Primary"
                              Disabled="true"
                              HelperText="Your username cannot be changed"
                              Class="profile-input" />

                <MudTextField @bind-Value="Input.PhoneNumber"
                              Label="Phone Number"
                              Variant="Variant.Outlined"
                              InputType="InputType.Telephone"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Rounded.Phone"
                              AdornmentColor="Color.Primary"
                              HelperText="Optional contact number"
                              Class="profile-input" />

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Large"
                           FullWidth="true"
                           StartIcon="@Icons.Material.Rounded.Save"
                           Class="profile-button">
                    Save Changes
                </MudButton>
            </MudStack>
        </EditForm>
    </MudPaper>

    <MudPaper Class="profile-card quick-links" Elevation="0">
        <div class="profile-card-header">
            <MudIcon Icon="@Icons.Material.Rounded.Settings" Color="Color.Primary" />
            <MudText Typo="Typo.h6">Quick Links</MudText>
        </div>

        <MudStack Spacing="2">
            <MudButton Variant="Variant.Text"
                       Color="Color.Primary"
                       Href="Account/Manage/Email"
                       StartIcon="@Icons.Material.Rounded.Email"
                       Class="quick-link-button">
                Manage Email
            </MudButton>
            <MudButton Variant="Variant.Text"
                       Color="Color.Primary"
                       Href="Account/Manage/ChangePassword"
                       StartIcon="@Icons.Material.Rounded.Lock"
                       Class="quick-link-button">
                Change Password
            </MudButton>
            <MudButton Variant="Variant.Text"
                       Color="Color.Primary"
                       Href="Account/Manage/TwoFactorAuthentication"
                       StartIcon="@Icons.Material.Rounded.Security"
                       Class="quick-link-button">
                Two-Factor Authentication
            </MudButton>
        </MudStack>
    </MudPaper>
</div>

<style>
    .manage-profile {
        max-width: 600px;
    }

    .profile-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 32px;
        padding: 24px;
        background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
        border-radius: 16px;
    }

    .profile-avatar {
        width: 72px !important;
        height: 72px !important;
        font-size: 1.75rem !important;
        font-weight: 600 !important;
        box-shadow: 0 4px 16px rgba(21, 101, 192, 0.3);
    }

    .profile-name {
        font-weight: 600 !important;
        color: #1a1a2e;
    }

    .profile-card {
        background: white !important;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        border: 1px solid #e0e6ed;
    }

    .profile-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e0e6ed;
    }

    .profile-input .mud-input-outlined-border {
        border-radius: 12px !important;
    }

    .profile-button {
        border-radius: 12px !important;
        padding: 12px 24px !important;
        font-weight: 600 !important;
        text-transform: none !important;
        margin-top: 8px;
    }

    .quick-links {
        background: #f8fafc !important;
    }

    .quick-link-button {
        justify-content: flex-start !important;
        text-transform: none !important;
        font-weight: 500 !important;
        padding: 12px 16px !important;
        border-radius: 12px !important;
    }

    .quick-link-button:hover {
        background: rgba(21, 101, 192, 0.08) !important;
    }

    @@media (max-width: 600px) {
        .profile-header {
            flex-direction: column;
            text-align: center;
        }
    }
</style>

@code {
    private ApplicationUser? user;
    private string? username;
    private string? phoneNumber;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();

        user = await UserManager.GetUserAsync(HttpContext.User);
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        username = await UserManager.GetUserNameAsync(user);
        phoneNumber = await UserManager.GetPhoneNumberAsync(user);

        Input.PhoneNumber ??= phoneNumber;
    }

    private async Task OnValidSubmitAsync()
    {
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        if (Input.PhoneNumber != phoneNumber)
        {
            var setPhoneResult = await UserManager.SetPhoneNumberAsync(user, Input.PhoneNumber);
            if (!setPhoneResult.Succeeded)
            {
                RedirectManager.RedirectToCurrentPageWithStatus("Error: Failed to set phone number.", HttpContext);
                return;
            }
        }

        await SignInManager.RefreshSignInAsync(user);
        RedirectManager.RedirectToCurrentPageWithStatus("Your profile has been updated", HttpContext);
    }

    private sealed class InputModel
    {
        [Phone]
        [Display(Name = "Phone number")]
        public string? PhoneNumber { get; set; }
    }
}
