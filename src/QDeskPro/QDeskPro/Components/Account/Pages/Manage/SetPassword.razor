@page "/Account/Manage/SetPassword"
@using MudBlazor
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using QDeskPro.Domain.Entities

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Set Password - QDeskPro</PageTitle>

<div class="set-password-page">
    <MudPaper Class="password-card" Elevation="0">
        <div class="password-card-header">
            <div class="password-icon">
                <MudIcon Icon="@Icons.Material.Rounded.VpnKey" />
            </div>
            <MudText Typo="Typo.h5" Class="password-title">Set Your Password</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Create a local password for your account
            </MudText>
        </div>

        <StatusMessage Message="@message" />

        <MudAlert Severity="Severity.Info" Class="mb-4" Icon="@Icons.Material.Rounded.Info">
            <MudText Typo="Typo.body2">
                You signed in with an external provider and don't have a local password.
                Setting a password allows you to log in directly without using an external service.
            </MudText>
        </MudAlert>

        <EditForm Model="Input" FormName="set-password" OnValidSubmit="OnValidSubmitAsync" method="post" Enhance>
            <DataAnnotationsValidator />

            <MudStack Spacing="3">
                <MudTextField @bind-Value="Input.NewPassword"
                              Label="New Password"
                              Variant="Variant.Outlined"
                              InputType="@(_showNewPassword ? InputType.Text : InputType.Password)"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_showNewPassword ? Icons.Material.Rounded.VisibilityOff : Icons.Material.Rounded.Visibility)"
                              AdornmentColor="Color.Default"
                              OnAdornmentClick="() => _showNewPassword = !_showNewPassword"
                              autocomplete="new-password"
                              Required="true"
                              RequiredError="New password is required"
                              HelperText="At least 6 characters"
                              Class="password-input" />

                <MudTextField @bind-Value="Input.ConfirmPassword"
                              Label="Confirm Password"
                              Variant="Variant.Outlined"
                              InputType="@(_showConfirmPassword ? InputType.Text : InputType.Password)"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_showConfirmPassword ? Icons.Material.Rounded.VisibilityOff : Icons.Material.Rounded.Visibility)"
                              AdornmentColor="Color.Default"
                              OnAdornmentClick="() => _showConfirmPassword = !_showConfirmPassword"
                              autocomplete="new-password"
                              Required="true"
                              RequiredError="Please confirm your password"
                              Class="password-input" />

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Large"
                           FullWidth="true"
                           StartIcon="@Icons.Material.Rounded.AddCircle"
                           Class="password-button">
                    Set Password
                </MudButton>
            </MudStack>
        </EditForm>

        <MudPaper Class="password-benefits" Elevation="0">
            <MudText Typo="Typo.body2" Class="font-weight-semibold mb-2">Benefits of a Local Password:</MudText>
            <MudStack Spacing="1">
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Color="Color.Success" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Log in without relying on external services</MudText>
                </MudStack>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Color="Color.Success" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Account access even if external provider is unavailable</MudText>
                </MudStack>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Color="Color.Success" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Enhanced account security options</MudText>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudPaper>
</div>

<style>
    .set-password-page {
        max-width: 500px;
    }

    .password-card {
        background: white !important;
        border-radius: 20px;
        padding: 32px;
        border: 1px solid #e0e6ed;
    }

    .password-card-header {
        text-align: center;
        margin-bottom: 28px;
    }

    .password-icon {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        background: linear-gradient(135deg, #43A047 0%, #2E7D32 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        color: white;
        box-shadow: 0 6px 24px rgba(46, 125, 50, 0.3);
    }

    .password-title {
        font-weight: 700 !important;
        color: #1a1a2e;
        margin-bottom: 8px;
    }

    .password-input .mud-input-outlined-border {
        border-radius: 12px !important;
    }

    .password-button {
        border-radius: 12px !important;
        padding: 12px 24px !important;
        font-weight: 600 !important;
        text-transform: none !important;
        margin-top: 8px;
    }

    .password-benefits {
        background: #f5f7fa !important;
        border-radius: 12px;
        padding: 16px;
        margin-top: 24px;
    }
</style>

@code {
    private string? message;
    private ApplicationUser? user;
    private bool _showNewPassword = false;
    private bool _showConfirmPassword = false;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();

        user = await UserManager.GetUserAsync(HttpContext.User);
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        var hasPassword = await UserManager.HasPasswordAsync(user);
        if (hasPassword)
        {
            RedirectManager.RedirectTo("Account/Manage/ChangePassword");
        }
    }

    private async Task OnValidSubmitAsync()
    {
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        var addPasswordResult = await UserManager.AddPasswordAsync(user, Input.NewPassword!);
        if (!addPasswordResult.Succeeded)
        {
            message = $"Error: {string.Join(",", addPasswordResult.Errors.Select(error => error.Description))}";
            return;
        }

        await SignInManager.RefreshSignInAsync(user);
        RedirectManager.RedirectToCurrentPageWithStatus("Your password has been set.", HttpContext);
    }

    private sealed class InputModel
    {
        [Required]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "New password")]
        public string? NewPassword { get; set; }

        [DataType(DataType.Password)]
        [Display(Name = "Confirm new password")]
        [Compare("NewPassword", ErrorMessage = "The new password and confirmation password do not match.")]
        public string? ConfirmPassword { get; set; }
    }
}
